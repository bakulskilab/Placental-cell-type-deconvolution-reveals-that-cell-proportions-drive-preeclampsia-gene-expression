---
title: "scRNA-seq import and QC of placental villous tissue"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::knit_engines$set(python = reticulate::eng_python)

#install.packages("package_name",  repos="http://cran.us.r-project.org") # Only this mirror worked for multiple packages
library(knitr)
library(tidyverse)
library(devtools)
library(Seurat)
#remotes::install_github('satijalab/seurat-wrappers')
library(SeuratWrappers)
library(cowplot)
library(rgl)
library(EnvStats)
library(reticulate)
library(clustree)
library(Matrix)

# Bioconductor packages
#remotes::install_github('chris-mcginnis-ucsf/DoubletFinder') #Install DoubletFinder and depends
library(batchelor)
library(edgeR)
library(scater)
# Set seed since this pipeline includes stochastic algorithms
set.seed(1)
# Set default working directory
data_dir <- "C:/Users/k_cam/Google Drive/Placenta_Cell_Types/RNA/placenta_rna/data/"
```
# Single-cell RNA-seq analysis of KC and TNL Pique-Regi placental villous tissue samples
### Important References
Minimal QC recommended: Current best practices in single‐cell RNA‐seq analysis: a tutorial
Orchestrating Single-cell Analysis
### Compiling Issues
This document had trouble compiling via knitr and pandoc. The following thread fixed the issue (https://github.com/rstudio/rstudio/issues/3661).

## Load Data
```{r}
seu <- readRDS(paste0(data_dir, "kc_pr_qc_merged_2020-12-15.rda"))
```

## QC Plots
Post-filtering QC violin plots. Cells that expressed more than 1000 genes detected in three or more cells are included for downstream analyses. Samples KC_40_1 and KC_40_2 have been renamed 1A and 1B. KC_42_1 and KC_42_2 have been renamed 2A and 2B.

```{r QC_plots}
VlnPlot(object=seu, features='nCount_RNA', pt.size=0.15, group.by = 'orig.ident') + NoLegend() + ggtitle("Total RNA Molecules") + theme(axis.title.x = element_blank())
VlnPlot(object=seu, features='nFeature_RNA',pt.size=0.15, group.by = 'orig.ident') + NoLegend() + ggtitle("Unique Genes Per Cell") + theme(axis.title.x = element_blank())
VlnPlot(object=seu, features='subsets_Mito_percent',pt.size=0.15, group.by = 'orig.ident') + NoLegend() + ggtitle("Percentage of Reads Mapping to Mitochondrial Genes") + theme(axis.title.x = element_blank())
```

## QC Tabulation
```{r QC_Tabulation}
# Total number of genes
#genes <- AverageExpression(object = All, features = 'nFeature_RNA', verbose = T)
#dim(genes$RNA)[1]
```

## Pre-processing for Clustering

After filtering of unwanted cells and QC assessment, the first step of clustering is to normalize the data. By default (used here), Seurat globally normalizes feature expression for each cell by total expression, multiplies by a scale factor of 10,000, and log-transforms the result.

Find variable features identifies variable genes in a feature selection step for downstream analysis. Default options are the "vst" selection method, and top 2000 features returned. The variance stabilizing transformation (VST) first fits a line to the relationship of log(variance) and log(mean) using local polynomial regression ("loess"). The second step standardizes the feature values using the observed mean and expected variance (given by the fitted line). Feature variance is then calculated on the standardized values after clipping to a maximum (clip.max parameter). "loess.span" is the span paramter used when fitting the variance-mean relationship. After standardization, values larger than "clip.max" will be set to "clip.max"; by default, is 'auto' which sets "clip.max" to the square root of the number of cells.

The top 25 most variables genes are labelled in the plot of standardized varaince versus average gene expression presented below. The top 2000 most variable genes are highlighted in red and are carried through for downstream analysis.

```{r Normalization_and_Feature_Selection}
# Should normalize and find variable features in each dataset separately
seu <- NormalizeData(object = seu, normalization.method = "LogNormalize", scale.factor = 10000)
seu <- FindVariableFeatures(object = seu)
```
Elbow plot to identify the dimensionality of the dataset. Seurat errs on the side of selecting more rather than fewer PCs because too few PCs can significantly affect the result.

ElbowPlot() plots the standard deviations (or approximate singular values if running PCAFast) of the principle components for easy identification of an elbow in the graph. This elbow often corresponds well with the significant dims.

GSEA could be conducted on the PCs to see if they identify cell types or a group of similar cell types.

50 looks like more than enough to capture the variability in the dataset.
```{r Dataset_Dimensionality}
ElbowPlot(object = seu, ndims = 100)
```
```{r}
DimPlot(seu, reduction = "pca", group.by = 'orig.ident')
```
## Uncorrected Clustering, t-SNE, UMAP 

Next, we use a non-linear dimensional reduction technique to embed the first 50 PCs of the dataset into two dimensions for visualization and exploration. Seurat recommends using the same number of PCs for t-SNE and neighbor-graph. Each point represents a single cell's transcriptome. Cells with similar gene expression profiles are plotted closer together. To identify communities (cell types in this biological context), Seurat creates a shared nearest neighbor graph and creates communities that optimize "modularity", the density of links within communities compared to links between communities.
```{r tSNE_cluster}
# Don't want to re-run
seu <- RunTSNE(seu, dims.use = 1:50, do.fast = T, dim.embed = 2)
seu <- FindNeighbors(object=seu, dims=1:50, reduction='pca')
seu <- RunUMAP(object = seu, dims = 1:50)
seu <- FindClusters(object = seu, resolution = 0.8) #default is 0.8; 0.2 looks stable in the kc dataset

table(seu@meta.data$seurat_clusters)
table(seu@meta.data$seurat_clusters,seu$orig.ident)

# tSNE plot by sample cluster
DimPlot(object = seu,pt.size=0.7,reduction='tsne',group.by='seurat_clusters', label = T)
DimPlot(object = seu,pt.size=0.7,reduction='tsne',group.by='orig.ident')
DimPlot(object = seu,pt.size=0.01,reduction='tsne',group.by='batch')

# UMAP plot by sample cluster
DimPlot(object = seu,pt.size=0.7,reduction='umap',group.by='ident', label = T)
DimPlot(object = seu,pt.size=0.01,reduction='umap',group.by='orig.ident')
DimPlot(object = seu,pt.size=0.01, reduction='umap',group.by='batch')

#saveRDS(All,file='combined_uncorrected.rda')
```
## MNN Correction and Clustering

Re-running pipeline after MNN correction, batch correct for KC40 vs. KC42
```{r}
#saveRDS(seu, paste0(data_dir, "fetal_assigned_res.0.3_",Sys.Date(), ".rda"))

# Mutual Nearest Neighbor Reduction
# RunFastMNN, splitting by biological replicate (i.e., KC40 vs. KC42 vs. each tnl sample)
seu <- RunFastMNN(object.list = SplitObject(seu, split.by = "biorep"))
DimPlot(object = seu,pt.size=0.7,reduction='mnn', group.by='orig.ident')
DimPlot(object = seu,pt.size=0.7,reduction='mnn', group.by='biorep')

# Re-run UMAP and cluster pipeline after MNN correction
seu <- RunUMAP(seu, reduction = "mnn", dims = 1:50)
seu <- FindNeighbors(seu, reduction = "mnn", dims = 1:50)
seu <- FindClusters(seu, resolution = 0.2)
```

```{r}
# 'biorep' is metadata describing biological replicates
DimPlot(seu, group.by = 'biorep')
# 'seurat_clusters' is metadata describing default clustering'
DimPlot(seu, group.by = 'seurat_clusters', label = T, pt.size = .25)
# 'SampleName' describes KC40A (1A), KC40B (1B), KC42A (2A), KC42B (2B)
DimPlot(seu, group.by = 'orig.ident')
DimPlot(seu, group.by = 'freemuxlet.assignments')
```
## Assigning maternal/fetal status and sex
Plotting several sex-specific transcripts, it is clear that KC42, PR478, and PR484 are all male fetuses. Markers come from "Robust and tissue-independent gender-specific transcript biomarkers.", published using peripheral blood as sample source (RPS4Y1, EIF1AY, DDX3Y, KDM5D and XIST; XIST being upregulated in females compared to males).
```{r}
VlnPlot(object= seu,
        features = c("XIST", "RPS4Y1", "EIF1AY", "DDX3Y", "KDM5D"),
        group.by = 'biorep')
```

Grouping by biological replicate and then splitting by freemux assignment (0/1), plotting the three most robustly expressed genes in the dataset, we clearly see that 0 (the more abundant of the two individuals) corresponds to the fetus in PR478 and PR484, and 1 corresponds to the fetus in KC42 (the less abundant of the two individuals). It can be inferred this pattern holds for PR481 and KC40, but will verify with placental gene expression below. 
```{r}
VlnPlot(object= seu,
        features = c("XIST", "RPS4Y1", "EIF1AY"),
        group.by = 'biorep',
        split.by = 'freemuxlet.assignments',
        split.plot = T)
```
Yes, the pattern holds, clearly visible in KRT7 in PR481, 0 is still the fetus in all the PR biological replicates. In other other genes, it looks like kc40.1 freemux 0 is the fetus
```{r}
VlnPlot(object= seu,
        features = c("KRT8"),
        group.by = 'orig.ident',
        split.by = 'freemuxlet.assignments',
        split.plot = T)
VlnPlot(object= seu,
        features = c("COL1A1"),
        group.by = 'orig.ident',
        split.by = 'freemuxlet.assignments',
        split.plot = T)
VlnPlot(object= seu,
        features = c("CD163"),
        group.by = 'orig.ident',
        split.by = 'freemuxlet.assignments',
        split.plot = T)
```

```{r}
VlnPlot(object= seu,
        features = c("total"),
        group.by = 'orig.ident',
        split.by = 'freemuxlet.assignments',
        split.plot = T)
VlnPlot(object= seu,
        features = c("detected"),
        group.by = 'orig.ident',
        split.by = 'freemuxlet.assignments',
        split.plot = T)
VlnPlot(object= seu,
        features = c("subsets_Mito_percent"),
        group.by = 'orig.ident',
        split.by = 'freemuxlet.assignments',
        split.plot = T)
```

From above, KC42, freemux 1 is the fetus. It looks like in almost every KC sample except kc.40.1, freemux 1 is the fetus.
Based on these findings, PR freemux 0 corresponds to fetus, KC freemux 0 corresponds to maternal except for KC40.1
```{r}
batch <- SplitObject(seu, split.by = "batch")
kc <- batch$kc
pr <- batch$pr
rm(batch)
DimPlot(kc, group.by = 'freemuxlet.assignments', split.by = 'orig.ident', pt.size = .25)
DimPlot(pr, group.by = 'freemuxlet.assignments', split.by = 'orig.ident', pt.size = .25)
rm(kc)
rm(pr)
```
Add maternal/fetal assignment and sex
```{r}
meta <- seu@meta.data
barcode <- rownames(meta)
df <- as_tibble(cbind(barcode, meta))
```

Use conditional mutate to recode fetal with helpful guide: https://rstudio-pubs-static.s3.amazonaws.com/116317_e6922e81e72e4e3f83995485ce686c14.html#/9
```{r}
meta.new <- df %>%
  mutate(fetal =
           if_else(
             grepl("pr", orig.ident),
             if_else(freemuxlet.assignments == 0,
                     TRUE,
                     FALSE),
             if_else(
               orig.ident == "kc.40.1",
               if_else(freemuxlet.assignments == 0,
                       TRUE,
                       FALSE),
               if_else(freemuxlet.assignments == 1,
                       TRUE,
                       FALSE)
             )
             
           )
  ) %>%
  mutate(sex =
           if_else(
             fetal == F,
             "female",
             if_else(
               biorep %in% c("kc.42", "pr.481", "pr.484"),
               "male",
               "female")
           )
  ) %>% select(barcode, fetal, sex, everything())
meta.new$fetal <- factor(meta.new$fetal,
                         levels = c(FALSE, TRUE),
                         labels = c("Maternal", "Fetal"))
meta.new$sex <- factor(meta.new$sex,
                         levels = c("female", "male"),
                         labels = c("Female", "Male"))

```

```{r}
seu <- AddMetaData(object = seu, metadata = meta.new$fetal, col.name = 'fetal')
seu <- AddMetaData(object = seu, metadata = meta.new$sex, col.name = 'sex')
```

```{r}
DimPlot(seu, group.by = 'fetal', pt.size = .25)
DimPlot(seu, group.by = 'biorep', split.by = 'fetal', pt.size = .25)
DimPlot(seu, group.by = 'sex', pt.size = .25)
```


```{r}
# Function that accepts Seurat  that has been processed up to the clustering step, clusters at desired resolutions (vector), adds cluster identities at different resolutions, and returns Seurat object with resolution cluster identities
Seurat_clustree <- function (seuratObject, resolutions) {
  
  for(hyperparameter in resolutions) {
    print(hyperparameter)
    prefix <- paste0("res.", hyperparameter)
    print(prefix)
    seuratObject <- FindClusters(object = seuratObject, resolution = hyperparameter)
    seuratObject <- AddMetaData(object = seuratObject, metadata = seuratObject$seurat_clusters, col.name = prefix)
  }
  return(seuratObject)
}

resolutions <- seq(from = 0.2, to = 0.7, by = .1)
seu <- Seurat_clustree(seu, resolutions)
```

Iterating over 0.2 to 0.7 clustering resolution, .3 looks stable. Additional divisions at .5
```{r clustree_graph}
clustree(seu, prefix = "res.", node_colour = "sc3_stability") + theme(legend.position = "bottom") + guides(edge_alpha = F)
```
res of 0.3 splits the large T-cell containing cluster into 4 groups instead of 2 and splits the monocyte group into 2 groups.
```{r}
# 'seurat_clusters' is metadata describing default clustering'
DimPlot(seu, group.by = 'res.0.3', label = T, pt.size = .25)
DimPlot(seu, group.by = 'res.0.2', label = T, pt.size = .25)
```

```{r}
# Reset default cluster resolution
seu <- FindClusters(seu, resolution = 0.3)
seu.res.0.7 <- FindAllMarkers(seu)
```

```{r explore_FindAllMarkers_hits}
All.mnn.res.0.7 %>%
  filter(All.mnn.res.0.7$cluster == 8) %>%
  View()

# Cluster 8 has decreased XIST expression, increased PAGE4, possibly npiCTB
All.mnn.res.0.7 %>%
  filter(All.mnn.res.0.7$gene == 'XIST') %>%
  View()
All.mnn.res.0.7 %>%
  filter(All.mnn.res.0.7$gene == 'PAGE4') %>%
  View()
```




```{r mnn_reduction_expression}
# MNN-corrected with UMAP   embeddings
#saveRDS(All.mnn.labelled, "tnl_combined_mnn_labelled.rda")
All.mnn.labelled <- readRDS("C:/Users/k_cam/Downloads/scRNA_hpc_qc/tnl_combined_mnn_labelled.rda")

# MNN-corrected cluster markers
All.mnn.labelled <- RenameIdents(object = All.mnn.labelled,
                         "0" = "Cytotrophoblasts",
                         "1" = "Naive T Cells",
                         "2" = "CD14+ Monocytes",
                         "3" = "B Cells",
                         "4" = "Activated T Cells",
                         "5" = "Natural Killer",
                         "6" = "Fibroblasts",
                         "7" = "FCGR3A+ Monocytes",
                         "8" = "npiCytotrophoblasts",
                         "9" = "Hofbauer Cells",
                         "10" = "Extravillous Trophoblasts",
                         "11" = "Synctyiotrophoblast",
                         "12" = "12",
                         "13" = "13",
                         "14" = "14",
                         "15" = "Endothelial Cells",
                         "16" = "pDC",
                         "17" = "17")
All.mnn.labelled <- RenameIdents(object = All.mnn.labelled,
                         "12" = "Immune Progenitor Mixture")

combined.mnn.res.0.7.labelled <- FindAllMarkers(All.mnn.labelled)

DimPlot(All.mnn.labelled, label = T, repel = T, label.size = 4, pt.size = .25) + NoLegend()
```
SRP 2020 Graphics
```{r}
srp <- subset(All.mnn.labelled, idents = -(""))
```

Cibersort manuscript contains helpful hematopoeitc reference genes: https://www-ncbi-nlm-nih-gov.proxy.lib.umich.edu/pmc/articles/PMC6610714/

```{r}
# Dendritic
FeaturePlot(object = All.mnn.labelled,
            features = c("FCER1A"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)
# Megakaryocytes
FeaturePlot(object = All.mnn.labelled,
            features = c("PPBP"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)
# Myeloid
FeaturePlot(object = All.mnn.labelled,
            features = c("CD68"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)
# CD4 T cells
FeaturePlot(object = All.mnn.labelled,
            features = c("CD3E", "CD4"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)
# CD8 T Cells
FeaturePlot(object = All.mnn.labelled,
            features = c("CD8A", "CD8B"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)
```


```{r Find_All_Markers}
All.mnn.labelled <- FindClusters(All.mnn.labelled, resolution = 0.7)
combined.mnn.res.0.7 <- FindAllMarkers(All.mnn.labelled)
saveRDS(combined.mnn.res.0.7, paste0(data_dir, "combined_res_0.7.rda"))

combined.mnn.res.0.7 <- combined.mnn.res.0.2

View(combined.mnn.res.0.7)
test <- combined.mnn.res.0.7
levels(test$cluster) <- c("Cytotrophoblasts","Naive T Cells", "CD14+ Monocytes", "B Cells", "Activated T Cells", "Natural Killer", "Fibroblasts", "FCGR3A+ Monocytes", "npiCytotrophoblasts", "Hofbauer Cells", "Extravillous Trophoblasts", "Synctyiotrophoblast", "12", "13", "14", "Endothelial Cells", "pDC", "17")

test.sorted <- test %>%
  arrange(cluster, desc(avg_logFC), p_val_adj)

write.csv(test, paste0(data_dir, "marker_genes_sorted.csv"))

combined.mnn.res.0.7 %>%
  filter(cluster == '13') %>%
  View()

combined.mnn.res.0.7 %>%
  filter(gene == 'NRP1') %>%
  View()

View(head(combined.mnn.res.0.7))

FeaturePlot(object = All.mnn.labelled,
            features = c("NKG7"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)
FeaturePlot(object = All.mnn.labelled,
            features = c("CD52"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)
FeaturePlot(object = All.mnn.labelled,
            features = c("SOX4"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)
FeaturePlot(object = All.mnn.labelled,
            features = c("SOX4"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)


# Clearly shows 15 is endothelial
VlnPlot(object=All.mnn.labelled, features = c("ESAM", "KDR"), pt.size=0.15) #+ NoLegend()# + ggtitle("Total RNA Molecules")+ theme(axis.title.x = element_blank())

# XAGE 3 expression is puzzling, clearly shows up in trophoblasts as well as 17 and 13
VlnPlot(object=All.mnn.labelled, features = c("XAGE3", "PAGE4"), pt.size=0.15)
# Clearly delineates trophoblasts, clusters 13 and 17 are interesting here
VlnPlot(object=All.mnn.labelled, features = c("PAGE4"), pt.size=0.15)


# 0, 8, 9, 11, 15, 17
VlnPlot(object=All.mnn.labelled, features = c("NRP1"), pt.size=0.15)

# Shows up in 6, 14, 17
VlnPlot(object=All.mnn.labelled, features = c("MGP"), pt.size=0.15)

# Placenta Growth Factor 0, 8, 10, 11, 17, and NOT 13
VlnPlot(object=All.mnn.labelled, features = c("PGF"), pt.size=0.15)


VlnPlot(object=All.mnn.labelled, features = c("CSH1"), pt.size=0.15)
VlnPlot(object=All.mnn.labelled, features = c("CSH2"), pt.size=0.15)

VlnPlot(object=All.mnn.labelled, features = c("COL1A1"), pt.size=0.15)
VlnPlot(object=All.mnn.labelled, features = c("CD34"), pt.size=0.15)

VlnPlot(object=All.mnn.labelled, features = c("CD44"), pt.size=0.15)

# Very interesting expression profile, including featured prominently in 16
VlnPlot(object=All.mnn.labelled, features = c("SOX4"), pt.size=0.15)

# Half of cluster 12 expresses PRSS57
VlnPlot(object=All.mnn.labelled, features = c("PRSS57"), pt.size=0.15)
VlnPlot(object=All.mnn.labelled, features = c("ITGAX"), pt.size=0.15)

# Hematopoietic stem cells markers, CD38lo
VlnPlot(object=All.mnn.labelled, features = c("CD34", "CD59"), pt.size=0.15)
VlnPlot(object=All.mnn.labelled, features = c("THY1", "CD38"), pt.size=0.15)

# Cell cycle genes, high in 8, outliers in 12/13
VlnPlot(object=All.mnn.labelled, features = c("CDK1", "RRM2", "CCNB1"), pt.size=0.15)

# Liu et al, 2018 found 2 mesenchymal subtypes in the 1st trimester placenta
VlnPlot(object=All.mnn.labelled, features = c("DLK1", "IGFBP7", "C1R"), pt.size=0.15)
VlnPlot(object=All.mnn.labelled, features = c("COL1A1"), pt.size=0.15)


cluster17vCTs <- FindMarkers(All.mnn.labelled, ident.1 = '17', ident.2 = '0')
View(cluster17vCTs)
cluster17vFBs <- FindMarkers(All.mnn.labelled, ident.1 = '17', ident.2 = '6')
View(cluster17vFBs)

cluster14v6 <- FindMarkers(All.mnn.labelled, ident.1 = '14', ident.2 = '6')
View(cluster14v6)

cluster12v15 <- FindMarkers(All.mnn.labelled, ident.1 = '12', ident.2 = '15')
View(cluster12v15)

cluster13vCTs <- FindMarkers(All.mnn.labelled, ident.1 = '13', ident.2 = '0')
View(cluster13vCTs)
```

```{r Subset unknown clusters and Preprocess}
# Subset to placental cells and unknown
placenta.subset <- subset(x = All.mnn.labelled, idents = c("Cytotrophoblasts", "Fibroblasts", "npiCytotrophoblasts", "Hofbauer Cells", "Extravillous Trophoblasts", "Synctyiotrophoblast", "12", "13", "14", "Endothelial Cells", "17"))
DimPlot(placenta.subset, reduction = "umap", label = T, pt.size = .1) + NoLegend()

placenta.subset <- FindVariableFeatures(placenta.subset)
# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(placenta.subset), 25)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(placenta.subset)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE, xnudge = 0, ynudge = 0)
plot2
placenta.subset <- ScaleData(placenta.subset)
```


```{r Subset_clusters}
# Re-run UMAP and cluster pipeline, using the same mnn-corrected reduction, just with different variable features
placenta.subset <- RunUMAP(placenta.subset, reduction = "mnn", dims = 1:50)
placenta.subset <- FindNeighbors(placenta.subset, reduction = "mnn", dims = 1:50)
placenta.subset <- FindClusters(placenta.subset, resolution = 0.2)

placenta.subset <- RenameIdents(object = placenta.subset,
                         "0" = "Cytotrophoblasts",
                         "1" = "Fibroblasts",
                         "2" = "npiCytotrophoblasts",
                         "3" = "Hofbauer Cells",
                         "4" = "Extravillous Trophoblasts",
                         "5" = "Syncytiotrophoblast Trajectory",
                         "6" = "6",
                         "7" = "7",
                         "8" = "8",
                         "9" = "Endothelial Cells",
                         "10" = "10")

#saveRDS(placenta.subset, paste0(data_dir, "placenta_subset.rda"))
placenta.subset <- readRDS(paste0(data_dir, "placenta_subset.rda"))

```

```{r doublet finder}
placenta.subset.doublets <- doubletFinder(placenta.subset, 25)
```

```{r FindAllMarkers}
placenta.all.markers <- FindAllMarkers(placenta.subset)
saveRDS(placenta.all.markers, paste0(data_dir, "placenta_all_markers.rda"))
placenta.all.markers <- readRDS(paste0(data_dir, "placenta_all_markers.rda"))
View(placenta.all.markers)

test <- placenta.all.markers

levels(test$cluster) <- c("Cytotrophoblasts", "Fibroblasts", "npiCytotrophoblasts", "Hofbauer Cells", "Extravillous Trophoblasts", "Syncytiotrophoblast Trajectory", "6", "7", "8", "Endothelial Cells", "10")
View(test)

test.sorted <- test %>%
  arrange(cluster, desc(avg_logFC), p_val_adj)

write.csv(test, paste0(data_dir, "placenta_marker_genes_sorted.csv"))

# Sort by logFC followed by the p-value
placenta.all.markers %>%
  filter(cluster == '7') %>%
  arrange(desc(avg_logFC), p_val_adj) %>%
  View()
```

```{r Subset clusters plots}
DimPlot(placenta.subset, label = T, repel = T, label.size = 4) + NoLegend()
DimPlot(placenta.subset, label = F, repel = T, label.size = 4, group.by = 'Sample', pt.size = .05)
DimPlot(placenta.subset, label = F, repel = T, label.size = 4, group.by = 'Sample', pt.size = .05)
```

```{r Subset - Marker Gene Expression}
# Clear EVT and Hofbauer cell divide
FeaturePlot(object = placenta.subset,
            features = c("CD163", "CD14"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)

# Extravillous Trophoblast (EVT)
FeaturePlot(object = placenta.subset,
            features = c("MMP2", "HLA-G"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)
VlnPlot(object=placenta.subset, features = c("MMP2", "HLA-G"), pt.size=0.15)
# Looks like EVTs came almost exclusively from the one female TNL sample
FeaturePlot(object = placenta.subset,
            features = c("RPS4Y1"),
            pt.size = 1)
VlnPlot(object=placenta.subset, features = c("RPS4Y1"), pt.size=0.15)

# Clear endothelial cell divide
FeaturePlot(object = placenta.subset,
            features = c("KDR", "ESAM"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)

# Syncytiotrophoblast markers indicate that there's probably only a very small number
FeaturePlot(object = placenta.subset,
            features = c("PSG1", "CSH1"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)

FeaturePlot(object = placenta.subset,
            features = c("CD8A", "CD4"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)

FeaturePlot(object = placenta.subset,
            features = c("CD8A", "PTPRC"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)
FeaturePlot(object = placenta.subset,
            features = c("CD8A", "NKG7"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)

VlnPlot(object=placenta.subset, features = c("PTPRC", "IL7R"), pt.size=0.15)

#8, 10, and fibroblasts express DES
VlnPlot(object=placenta.subset, features = c("DES", "CD248"), pt.size=0.15)
VlnPlot(object=placenta.subset, features = c("PECAM1"), pt.size=0.15)

# Expressed in 8, middling expression in 10. High expression in Progenitor mixture
VlnPlot(object=placenta.subset, features = c("VIM"), pt.size=0.15)


FeaturePlot(object = placenta.subset,
            features = c("VIM", "PTPRC"),
            cols = c("lightgrey", "blue"),
            pt.size = .1)

```

## Save/Load
```{r reset_All}
#For Graphing below
All <- readRDS("E:/All_mnn_labelled_subcluster.rda")
#All <- All.mnn.labelled.subcluster
```

## Cluster-specific QC Metrics
```{r cluster_QC_metrics}
VlnPlot(object=All, features='nCount_RNA', pt.size=0.15) + NoLegend() + ggtitle("Total RNA Molecules")+ theme(axis.title.x = element_blank())
VlnPlot(object=All, features='nFeature_RNA', pt.size=0.15) + NoLegend() + ggtitle("Unique Genes Per Cell") + theme(axis.title.x = element_blank())
VlnPlot(object=All, features='percent.mito', pt.size=0.15) + NoLegend() + ggtitle("Percentage of Reads Mapping to Mitochondrial Genes") + theme(axis.title.x = element_blank())
```

```{r WIP Supplemental Figure 4 Correlation}
# From https://github.com/satijalab/seurat/issues/1313
# In Seurat, easiest method is to average expression across genes, and then use correlation functions

# Subset to individual samples
One.A <- subset(All, subset = SampleName=="1A")
One.B <- subset(All, subset = SampleName=="1B")
Two.A <- subset(All, subset = SampleName=="2A")
Two.B <- subset(All, subset = SampleName=="2B") 

# Calculate average gene expression across all cells by cluster
One.A.avg <- AverageExpression(One.A)
One.B.avg <- AverageExpression(One.B)
Two.A.avg <- AverageExpression(Two.A)
Two.B.avg <- AverageExpression(Two.B)

# Biological Correlation
KC40 <- subset(x = All, subset = (Sample == "KC40"))
KC42 <- subset(x = All, subset = (Sample == "KC42"))

pearson_bio_cor <- vector(mode=  'numeric', length = 18)
names(pearson_bio_cor) <- colnames(KC40_expression$RNA)

spearman_bio_cor <- vector(mode=  'numeric', length = 18)
names(spearman_bio_cor) <- colnames(KC40_expression$RNA)

levels(factor(All$SampleName))

dim(All$SampleName)

# Subset Seurat objects to each sample and average expression across cells within clusters
for(sample in levels(factor(All$SampleName))) {
  ObjectName <- paste0("Expression", sample)
  assign(ObjectName, AverageExpression(subset(x = All, subset = (SampleName == sample))))
}

for(i in colnames(KC40_expression$RNA)) {
  
  p_cor <- cor(x = KC40_expression$RNA[[i]], y = KC42_expression$RNA[[i]], method = "pearson")
  spear_cor <- cor(x = KC40_expression$RNA[[i]], y = KC42_expression$RNA[[i]], method = "spearman")
  
  pearson_bio_cor[[i]] <- p_cor
  spearman_bio_cor[[i]] <- spear_cor
}

# Pairwise Correlation

# Distance as a measure of reproducibility in high throughput sequencing
# https://simplystatistics.org/2015/08/12/correlation-is-not-a-measure-ofreproducibility/

# Takes in a 
distance_reproducibility <- function(assay) {
  
  for(sample in colnames(assay)) {
    
  }
  
}

pearson_bio_cor <- vector(mode=  'numeric', length = 18)
names(pearson_bio_cor) <- colnames(KC40_expression$RNA)

spearman_bio_cor <- vector(mode=  'numeric', length = 18)
names(spearman_bio_cor) <- colnames(KC40_expression$RNA)

for(i in colnames(KC40_expression$RNA)) {
  
  p_cor <- cor(x = KC40_expression$RNA[[i]], y = KC42_expression$RNA[[i]], method = "pearson")
  spear_cor <- cor(x = KC40_expression$RNA[[i]], y = KC42_expression$RNA[[i]], method = "spearman")
  
  pearson_bio_cor[[i]] <- p_cor
  spearman_bio_cor[[i]] <- spear_cor
}

```

Gene Expression plots for UMAP.
```{r Expression}
#Fig 1.B
p <- FeaturePlot(object = All,
            features = c("CD79A", "CD4", "CD8A", "CD14"),
            cols = c("lightgrey", "blue"),
            blend = F,
            pt.size = 0.25,
            combine = F)
for(i in 1:length(p)) {
  p[[i]] <- p[[i]] + NoLegend() + NoAxes()
}
cowplot::plot_grid(plotlist = p)


DotPlot(All, feature = c("CD79A", "CD4", "CD8A", "CD14"))
```