---
title: "KC and PR scRNA-seq import of filtered 10x output and QC of placental villous tissue"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::knit_engines$set(python = reticulate::eng_python)

#install.packages("package_name",  repos="http://cran.us.r-project.org") # Only this mirror worked for multiple packages
library(ggpubr)
library(here)
library(knitr)
library(tidyverse)
library(devtools)
library(Seurat)
library(cowplot) 
library(rgl)
library(EnvStats)
library(Matrix)

# Bioconductor packages
# library(DropletUtils)
library(edgeR)
library(scater)
```
### Important References
Minimal QC recommended: Current best practices in single‐cell RNA‐seq analysis: a tutorial
Orchestrating Single-cell Analysis
https://bioconductor.org/packages/release/bioc/vignettes/DropletUtils/inst/doc/DropletUtils.html
### Compiling Issues
This document had trouble compiling via knitr and pandoc. The following thread fixed the issue (https://github.com/rstudio/rstudio/issues/3661).

## Custom function to create list of Seurat objects from 10x output directories
```{r}
# Function to convert from 10x output to seurat object with no filtering
tenx_to_seu <- function(tenx_directory, name) {
  seu <- CreateSeuratObject(
    counts = Read10X(tenx_directory),
    project = name)
  return(seu)
}
```

## Unfiltered 10x output stats
Unfiltered 10x output data have been stored as dgCMatrix. Vector is all caps represent final columns for supplemental table. Chunk contains TOTAL.DROPLETS.RAW, TOTAL.RNA.RAW, TOTAL.GENES.RAW, FETAL.SEX.
```{r}
# Get raw 10X data directory
tenx.raw.out <- paste0(here("data", "tenx_unfiltered_data"), "/")
# Get filenames
names.raw <-
  grep(
    dir(
      path = tenx.raw.out             #list all files, unfortunately includes .ini files
      ),
    pattern = "(kc|tnl|tsang)",        #pattern to search for, excludes .ini files
    value = T                    #return matches
    )
# Get files 
files <-
  paste0(
    tenx.raw.out, 
    names.raw
  )
# Read files into R
raw.list <- lapply(files, function(x) readRDS(x))
# Rename according to naming convention
LIBRARY.ID <- c("1A", "1B", "2A", "2B", "3", "4", "5", "6", "7", "8C", "8P", "9C", "9P", "PE1", "PE2", "PE3", "PE4")
names(raw.list) <- LIBRARY.ID
# Create a Seurat object out of each file
raw.seurat <- lapply(raw.list, function(x) CreateSeuratObject(counts = x))
# Clean-up memory
rm(raw.list)

# Get number of total droplets sequenced (always 737280)
TOTAL.DROPLETS.RAW <- lapply(raw.seurat, function(x) x %>% ncol()) %>% as.numeric
# Total unique RNA molecules
TOTAL.RNA.RAW <- lapply(raw.seurat, function(x) x$nCount_RNA %>% sum()) %>% as.numeric
# Total unique genes measured
TOTAL.GENES.RAW <- lapply(raw.seurat, function(x) x %>% nrow()) %>% as.numeric
# Sex of samples
FETAL.SEX <- c("F", "F", "M", "M", "M", "F", "M", "M", "M", "F", "F", "F", "F", "M", "M", "F", "F")
```

## Get list of droplet-called and filtered Seurat objects
Contains TOTAL.CELLS
```{r}
tenx_out <- paste0(here("data", "tenx_outs"), "/")
# Pull full file paths
names <- 
  grep(
    dir(
      path = tenx_out             #list all files, unfortunately includes .ini files
      ),
    pattern = "(kc|pr|tsang)", #pattern to search for, excludes .ini files
    value = T                    #return matches
    )
files <-
  paste0(
    tenx_out, 
    names
  )

# Create list of Seurat objects
counts <- map2(files, names, tenx_to_seu)
# Name list
names(counts) <- names
# Manually add batch metadata to distinguish kc from pr
counts$kc.40.1$'batch' <- "kc"
counts$kc.40.2$'batch' <- "kc"
counts$kc.42.1$'batch' <- "kc"
counts$kc.42.2$'batch' <- "kc"
counts$pr.478$'batch' <- "pr"
counts$pr.481$'batch' <- "pr"
counts$pr.484$'batch' <- "pr"
counts$tsang_n1$'batch' <- "tsang"
counts$tsang_n2$'batch' <- "tsang"
counts$tsang_n3c$'batch' <- "tsang"
counts$tsang_n3p$'batch' <- "tsang"
counts$tsang_n4c$'batch' <- "tsang"
counts$tsang_n4p$'batch' <- "tsang"
counts$tsang_pe1$'batch' <- "tsang"
counts$tsang_pe2$'batch' <- "tsang"
counts$tsang_pe3$'batch' <- "tsang"
counts$tsang_pe4$'batch' <- "tsang"
# Manually add bioreplicate metadata
counts$kc.40.1$'biorep' <- "kc.40"
counts$kc.40.2$'biorep' <- "kc.40"
counts$kc.42.1$'biorep' <- "kc.42"
counts$kc.42.2$'biorep' <- "kc.42"
counts$pr.478$'biorep' <- "pr.478"
counts$pr.481$'biorep' <- "pr.481"
counts$pr.484$'biorep' <- "pr.484"
counts$tsang_n1$'biorep' <- "tsang_n1"
counts$tsang_n2$'biorep' <- "tsang_n2"
counts$tsang_n3c$'biorep' <- "tsang_n3"
counts$tsang_n3p$'biorep' <- "tsang_n3"
counts$tsang_n4c$'biorep' <- "tsang_n4"
counts$tsang_n4p$'biorep' <- "tsang_n4"
counts$tsang_pe1$'biorep' <- "tsang_pe1"
counts$tsang_pe2$'biorep' <- "tsang_pe2"
counts$tsang_pe3$'biorep' <- "tsang_pe3"
counts$tsang_pe4$'biorep' <- "tsang_pe4"

TOTAL.CELLS <- lapply(counts, function(x) ncol(x)) %>% as.numeric()
```

## Create list of freemuxlet raw output data
```{r}
freemux_dir <- paste0(here("data", "freemuxlet", "raw_data"), "/")
names <- 
  grep(
    dir(
      path = freemux_dir             #list all files, unfortunately includes .ini files
      ),
    pattern = "(kc|pr|tsang)", #pattern to search for, excludes .ini files
    value = T                    #return matches
    )
files <-
  paste0(
    freemux_dir, 
    names
  )
# Read in freemuxlet dataframes, specifying the datatype in each column
freemux.clusters <- lapply(files, readr::read_tsv, col_types = "iciiffdfddddfdfddfdd")
names(freemux.clusters) <- names

# Optional 'QC' freemux output in freemuxlet_analysis_tsang.Rmd
```

TESTING
No na's among raw freemux data
```{r}
freemux.clusters$tsang_n4p.clusters$BEST.GUESS %>% is.na %>% summary
lapply(freemux.clusters, function(x) x$BEST.GUESS %>% as.factor %>% is.na %>% summary)
```

## Custom function to add freemuxlet cluster assignment to Seurat MetaData
```{r}
# Add freemuxlet cluster assignment to Seurat Metadata
AddFreemuxletMetaData <- function(seu, freemux.data, col.name) {
  seu.barcodes <- tibble (
    BARCODE = rownames(seu@meta.data)) # get barcodes list from Seurat object
  join <- left_join(                      # join freemuxlet assignment with barcodes
    seu.barcodes,
    freemux.data %>%
      dplyr::select(BARCODE, BEST.GUESS) %>%
      mutate(
        BEST.GUESS = fct_recode(          # Refactor freemuxlet assignments
          BEST.GUESS,
          "1" = "1,1",
          "0" = "0,0",
          "doublet" = "1,0"
        )
      )
  )
  seu <- AddMetaData(seu,                 # Add MetaData to Seurat object
                     join %>% pull(BEST.GUESS),
                     col.name = col.name)
  return(seu)                             # Return augmented Seurat object
}
```

## Add freemuxlet cluster assignment to Seurat objects
Error output for pr.478 and n4p because it is the only dataset with no assigned doublets. Output appears normal otherwise
```{r}
mapped <-
  map2(counts,                              # List of Seurat objects
       freemux.clusters,                    # List of freemuxlet raw data
       AddFreemuxletMetaData,               # Function to call
       col.name = "freemuxlet.assignments") # Every metadata column has same name
```

```{r}
lapply(mapped, function(x) dim(x@meta.data))
```

```{r}
# Sum of mapped
#2573+2600+2544+2740+1907+2653+2456+6018+16968+4918+2284+3137+3612+13659+4025+8084+13149
# sum of all freemuxlet is 93009
#dim(all)
# Difference explains the 318 cells in the mapped dataset that are missing from the raw freemuxlet data
#93327-93009
# = 318
```

TESTING
Missing barcodes come from tsang_n1 and tsang_n2
```{r}
lapply(mapped, function(x) x$freemuxlet.assignments %>% as.factor %>% is.na %>% summary)
```

```{r}
rm(counts)       # Remove data
rm(freemux.clusters) # Remove data
```

## Merge Seurat objects and remove doublets
Chunk contains FETAL.MATERNAL.DOUBLETS.REMOVED
```{r}
# Merge, adding cell id information because barcodes can and have been duplicated across experiments
kc.seu <- merge(x = mapped[[1]],                # Seurat object
             y = mapped[(2:4)],                  # List
             add.cell.ids = names(mapped)[1:4])   # Add cell IDs using names

# Identify number of cells removed for doublets
doublets.kc <- 
  kc.seu@meta.data %>%
  mutate(doublet = as.factor(freemuxlet.assignments)) %>%
  group_by(orig.ident, doublet) %>%
  tally() %>%
  filter(doublet == "doublet") %>%
  dplyr::select(n)
doublets.kc <- doublets.kc$n

# Remove doublets
kc.seu <- subset(x = kc.seu,
              subset = freemuxlet.assignments == "doublet",
              invert = T)

# Merge, adding cell id information because barcodes can and have been duplicated across experiments
pr.seu <- merge(x = mapped[[5]],                # Seurat object
             y = mapped[(6:7)],             # List
             add.cell.ids = names(mapped)[5:7])   # Add cell IDs using names

# Identify number of cells removed for doublets
doublets.pr <- 
  pr.seu@meta.data %>%
  mutate(doublet = as.factor(freemuxlet.assignments)) %>%
  group_by(orig.ident, doublet) %>%
  tally() %>%
  filter(doublet == "doublet") %>%
  dplyr::select(n)
doublets.pr <- c(0, doublets.pr$n)

pr.seu <- subset(x = pr.seu,
              subset = freemuxlet.assignments == "doublet",
              invert = T)

# Merge, adding cell id information because barcodes can and have been duplicated across experiments
tsang.seu <- merge(x = mapped[[8]],                # Seurat object
             y = mapped[(9:17)],                  # List
             add.cell.ids = names(mapped)[8:17])   # Add cell IDs using names

# Identify number of cells removed for doublets
doublets.tsang <- 
  tsang.seu@meta.data %>%
  mutate(doublet = as.factor(freemuxlet.assignments)) %>%
  group_by(orig.ident, doublet) %>%
  tally() %>%
  filter(doublet == "doublet") %>%
  dplyr::select(n)
doublets.tsang <- doublets.tsang$n

# Manually add 0 doublets removed for sample tsang_n4p, similar to pr 478
doublets.tsang <- c(doublets.tsang[1], doublets.tsang[2], doublets.tsang[3], doublets.tsang[4], 0, doublets.tsang[5],
                    doublets.tsang[6], doublets.tsang[7], doublets.tsang[8], doublets.tsang[9])

# Remove doublets and droplets that were dropped from pileup
tsang.seu <- subset(x = tsang.seu,
              subset = freemuxlet.assignments == "doublet" | is.na(freemuxlet.assignments),
              invert = T)

FETAL.MATERNAL.DOUBLETS.REMOVED <- c(doublets.kc, doublets.pr, doublets.tsang)
```

# KC QC
```{r}
# Convert to SingleCellExperiment for QC
sce <- as.SingleCellExperiment(kc.seu)
# Factorize the batch variable
sce$batch <- as.factor(sce$batch)
```

## Droplet Calling
Skipping droplet calling since 10x already filters that under Cell Ranger 4.0 based on Aaron Lun's EmptyDroplets().

## Calculate QC Metrics
Increased NMADs to 4 because NMAD of 3.0 looks too restrictive for KC data. Looks like an appropriate compromise based on QC plots.
```{r}
# Find mitochondrial genes
is.mito <- grepl("^MT-", rownames(sce))
# Add per cell QC metrics to the object
sce <- addPerCellQC(sce, subsets = list(Mito=is.mito))

# Create QC data frame
qc.df <- perCellQCMetrics(sce, subsets = list(Mito=is.mito))
# Reasons for exclusion, considering batch
batch.reasons <- quickPerCellQC(qc.df, batch=sce$batch,
                                sub.fields = "subsets_Mito_percent",
                                nmads = 4)
colSums(as.matrix(batch.reasons))

# Add discard metadata to object
sce$discard <- batch.reasons$discard
discard <- batch.reasons$discard

# See http://bioconductor.org/books/3.14/OSCA.basic/quality-control.html#common-choices-of-qc-metrics for further discussion of MAD
# Performed on the log scale to avoid negative values, and backtransform the result for plotting
#sce.rna.threshold = exp(median(log(sce$sum)) - 4*mad(log(sce$sum)))
#sce.gene.threshold = exp(median(log(sce$detected)) - 4*mad(log(sce$detected)))
#sce.mito.threshold = median(sce$subsets_Mito_percent) + 4*mad(sce$subsets_Mito_percent)

#sce.rna.threshold
#sce.gene.threshold
#sce.mito.threshold

# The actual set of functions to retrieve the thresholds; matches those manually calculated above (commented out)
sce.rna.threshold <- attr(batch.reasons$low_lib_size, "thresholds")[1]
sce.gene.threshold <- attr(batch.reasons$low_n_features, "thresholds")[1]
sce.mito.threshold <- attr(batch.reasons$high_subsets_Mito_percent, "thresholds")[2]

# Add thresholds metadata to object
sce$rna.threshold <- sce.rna.threshold
sce$gene.threshold <- sce.gene.threshold
sce$mito.threshold <- sce.mito.threshold
```

QC plots.
```{r}
plotColData(sce, x="sum", y="subsets_Mito_percent", colour_by = "discard") + scale_x_log10() +
  geom_vline(xintercept = sce.rna.threshold, linetype = "dashed") +
  geom_hline(yintercept = sce.mito.threshold, linetype = "dashed")
plotColData(sce, x="detected", y="subsets_Mito_percent", colour_by = "discard") + scale_x_log10() +
  geom_vline(xintercept = sce.gene.threshold, linetype = "dashed") +
  geom_hline(yintercept = sce.mito.threshold, linetype = "dashed") 
```

```{r}
plotColData(sce, x="ident", y="sum", colour_by="discard") + 
        scale_y_log10() + ggtitle("Total count")
plotColData(sce, x="ident", y="detected", colour_by="discard") + 
        scale_y_log10() + ggtitle("Detected features")
plotColData(sce, x="ident", y="subsets_Mito_percent", 
        colour_by="discard") + ggtitle("Mito percent")
```

Exploratory investigation of variance explained by metadata.
```{r}
#vars <- getVarianceExplained(logNormCounts(sce), 
#    variables=c("ident", "subsets_Mito_percent", "sum", "detected"))
#plotExplanatoryVariables(vars)
```

Subset to QC-filtered cells.
```{r}
# Keeping the columns we DON'T want to discard.
filtered <- sce[,!discard]
dropped <- as.numeric(summary(discard)["TRUE"])
kept <- as.numeric(summary(discard)["FALSE"])
print(paste0(dropped, " cells were filtered, yielding ", kept, " remaining cells"))
```

Identify if a rare cell type might have been discarded.
```{r}
lost <- calculateAverage(counts(sce)[,!discard])
kept <- calculateAverage(counts(sce)[,discard])

logged <- edgeR::cpm(cbind(lost, kept), log=TRUE, prior.count=2)
logFC <- logged[,1] - logged[,2]
abundance <- rowMeans(logged)
```

Blue points are mitochondrial genes and are expected to be downregulated. Exclusion of a cell type may be indicated by overexpression on this plot, of which there does not appear to be strong overexpression.
```{r}
plot(abundance, logFC, xlab="Average count", ylab="Log-FC (lost/kept)", pch=16)
points(abundance[is.mito], logFC[is.mito], col="dodgerblue", pch=16)
```
Even at NMAD = 4, CSH1 is differentially underexpressed, indicates omission of syncytiotrophoblasts, possibly correct since syncytiotrophoblast may have been differentially technically less sound.
```{r}
# Pull out differentially regulated genes
logFC[logFC < -2]

plotExpression(sce, features = "CSH1", x = "subsets_Mito_percent")
plotExpression(filtered, features = "CSH1", x = "subsets_Mito_percent")

plotExpression(sce, features = "CSH1", x = "total")
plotExpression(filtered, features = "CSH1", x = "total")

plotExpression(sce, features = "CSH1", x = "detected")
plotExpression(filtered, features = "CSH1", x = "detected")
```

Convert to Seurat object for further preprocessing and analysis and save.
```{r}
kc <- as.Seurat(filtered)
#saveRDS(kc, paste0(data_dir, "placenta_scRNA_seq_kc_filtered_", Sys.Date(), ".rda"))
```

Explore batch effect in KC samples. There doesn't appear to be much of a batch effect.
```{r}
# Should normalize and find variable features in each dataset separately
kc <- NormalizeData(object = kc, normalization.method = "LogNormalize", scale.factor = 10000)
kc <- FindVariableFeatures(object = kc)
kc <- ScaleData(kc)
kc <- RunPCA(kc, features = VariableFeatures(object = kc))
ElbowPlot(object = kc, ndims = 100)
DimPlot(kc, reduction = "pca", group.by = 'orig.ident')
DimPlot(kc, reduction = "pca", group.by = 'biorep')
```

```{r}
# Rename Samples KC_40_1 and KC_40_2 have been renamed 1A and 1B; KC_42_1 and KC_42_2 <- 2A and 2B.
#levels(All@active.ident) <- c("Placenta 1A", "Placenta 1B", "Placenta 2A", "Placenta 2B")
```

# Pique-Regi data QC

```{r}
# Convert to SingleCellExperiment for QC
sce.pr <- as.SingleCellExperiment(pr.seu)
# Factorize the batch variable
sce.pr$batch <- as.factor(sce.pr$batch)
# Clean-up memory
# rm(seu)
```

## Droplet Calling
Skipping droplet calling since 10x already filters that under Cell Ranger 4.0 based on Aaron Lun's EmptyDroplets().

## Calculate QC Metrics
Deafult NMAD of 3.0 looks too restrictive for KC data but looks fine for PR data.
```{r}
# Find mitochondrial genes
is.mito <- grepl("^MT-", rownames(sce.pr))
# Add per cell QC metrics to the object
sce.pr <- addPerCellQC(sce.pr, subsets = list(Mito=is.mito))

# Create QC data frame
qc.df <- perCellQCMetrics(sce.pr, subsets = list(Mito=is.mito))
# Reasons for exclusion, considering batch
batch.reasons <- quickPerCellQC(qc.df,
                                sub.fields = "subsets_Mito_percent",
                                nmads = 3) # default nmads is 3
colSums(as.matrix(batch.reasons))

# Add discard metadata to object
sce.pr$discard <- batch.reasons$discard
discard <- batch.reasons$discard

# Pull thresholds
sce.pr.rna.threshold <- attr(batch.reasons$low_lib_size, "thresholds")[1]
sce.pr.gene.threshold <- attr(batch.reasons$low_n_features, "thresholds")[1]
sce.pr.mito.threshold <- attr(batch.reasons$high_subsets_Mito_percent, "thresholds")[2]

# Add thresholds metadata to object
sce.pr$rna.threshold <- sce.pr.rna.threshold
sce.pr$gene.threshold <- sce.pr.gene.threshold
sce.pr$mito.threshold <- sce.pr.mito.threshold
```

QC plots.
```{r}
plotColData(sce.pr, x="sum", y="subsets_Mito_percent", colour_by = "discard") + scale_x_log10() +
  geom_vline(xintercept = sce.pr.rna.threshold, linetype = "dashed") +
  geom_hline(yintercept = sce.pr.mito.threshold, linetype = "dashed")
plotColData(sce.pr, x="detected", y="subsets_Mito_percent", colour_by = "discard") + scale_x_log10() +
  geom_vline(xintercept = sce.pr.gene.threshold, linetype = "dashed") +
  geom_hline(yintercept = sce.pr.mito.threshold, linetype = "dashed") 
```

```{r}
plotColData(sce.pr, x="ident", y="sum", colour_by="discard") + 
        scale_y_log10() + ggtitle("Total count")
plotColData(sce.pr, x="ident", y="detected", colour_by="discard") + 
        scale_y_log10() + ggtitle("Detected features")
plotColData(sce.pr, x="ident", y="subsets_Mito_percent", 
        colour_by="discard") + ggtitle("Mito percent")
```
Exploratory investigation of variance explained by metadata.
```{r}
#vars <- getVarianceExplained(logNormCounts(sce.pr), 
#    variables=c("ident", "subsets_Mito_percent", "sum", "detected"))
#plotExplanatoryVariables(vars)
```

Subset to QC-filtered cells.
```{r}
# Keeping the columns we DON'T want to discard.
filtered <- sce.pr[,!discard]
dropped <- as.numeric(summary(discard)["TRUE"])
kept <- as.numeric(summary(discard)["FALSE"])
print(paste0(dropped, " cells were filtered, yielding ", kept, " remaining cells"))
```

Identify if a rare cell type might have been discarded.
```{r}
lost <- calculateAverage(counts(sce.pr)[,!discard])
kept <- calculateAverage(counts(sce.pr)[,discard])

logged <- edgeR::cpm(cbind(lost, kept), log=TRUE, prior.count=2)
logFC <- logged[,1] - logged[,2]
abundance <- rowMeans(logged)
```

Blue points are mitochondrial genes and are expected to be downregulated. Exclusion of a cell type may be indicated by overexpression on this plot, of which there does not appear to be strong overexpression.
```{r}
plot(abundance, logFC, xlab="Average count", ylab="Log-FC (lost/kept)", pch=16)
points(abundance[is.mito], logFC[is.mito], col="dodgerblue", pch=16)
```

No clear cell types omitted based on my prior knowledge.
```{r}
logFC[logFC < -2]
```

Convert to Seurat object for further preprocessing and analysis and save.
```{r}
pr <- as.Seurat(filtered)
```

Explore batch effect in PR samples. There may be some batch effect in 481 (4) compared to 478 (3) and 484 (5)
```{r}
# Should normalize and find variable features in each dataset separately
pr <- NormalizeData(object = pr, normalization.method = "LogNormalize", scale.factor = 10000)
pr <- FindVariableFeatures(object = pr)
pr <- ScaleData(pr)
pr <- RunPCA(pr, features = VariableFeatures(object = pr))
ElbowPlot(object = pr, ndims = 100)
DimPlot(pr, reduction = "pca", group.by = 'orig.ident')
```

# Tsang QC
```{r}
# Convert to SingleCellExperiment for QC
sce.tsang <- as.SingleCellExperiment(tsang.seu)
# Factorize the batch variable
sce.tsang$batch <- as.factor(sce.tsang$batch)
```

## Droplet Calling
Skipping droplet calling since 10x already filters that under Cell Ranger 4.0 based on Aaron Lun's EmptyDroplets().

## Calculate QC Metrics
Default NMAD of 3 Looks like an appropriate level fro the Tsang data based on QC plots.
```{r}
# Find mitochondrial genes
is.mito <- grepl("^MT-", rownames(sce.tsang))
# Add per cell QC metrics to the object
sce.tsang <- addPerCellQC(sce.tsang, subsets = list(Mito=is.mito))

# Create QC data frame
qc.df <- perCellQCMetrics(sce.tsang, subsets = list(Mito=is.mito))
# Reasons for exclusion, considering batch
batch.reasons <- quickPerCellQC(qc.df, batch=sce.tsang$batch,
                                sub.fields = "subsets_Mito_percent",
                                nmads = 3)
colSums(as.matrix(batch.reasons))

# Add discard metadata to object
sce.tsang$discard <- batch.reasons$discard
discard <- batch.reasons$discard

# Pull thresholds
sce.tsang.rna.threshold <- attr(batch.reasons$low_lib_size, "thresholds")[1]
sce.tsang.gene.threshold <- attr(batch.reasons$low_n_features, "thresholds")[1]
sce.tsang.mito.threshold <- attr(batch.reasons$high_subsets_Mito_percent, "thresholds")[2]

# Add thresholds metadata to object
sce.tsang$rna.threshold <- sce.tsang.rna.threshold
sce.tsang$gene.threshold <- sce.tsang.gene.threshold
sce.tsang$mito.threshold <- sce.tsang.mito.threshold
```

QC plots.
```{r}
plotColData(sce.tsang, x="sum", y="subsets_Mito_percent", colour_by = "discard") + scale_x_log10() +
  geom_vline(xintercept = sce.tsang.rna.threshold, linetype = "dashed") +
  geom_hline(yintercept = sce.tsang.mito.threshold, linetype = "dashed")
plotColData(sce.tsang, x="detected", y="subsets_Mito_percent", colour_by = "discard") + scale_x_log10() +
  geom_vline(xintercept = sce.tsang.gene.threshold, linetype = "dashed") +
  geom_hline(yintercept = sce.tsang.mito.threshold, linetype = "dashed") 
```

```{r}
plotColData(sce.tsang, x="ident", y="sum", colour_by="discard") + 
        scale_y_log10() + ggtitle("Total count")
plotColData(sce.tsang, x="ident", y="detected", colour_by="discard") + 
        scale_y_log10() + ggtitle("Detected features")
plotColData(sce.tsang, x="ident", y="subsets_Mito_percent", 
        colour_by="discard") + ggtitle("Mito percent")
```
Exploratory investigation of variance explained by metadata.
```{r}
#vars <- getVarianceExplained(logNormCounts(sce.tsang), 
#    variables=c("ident", "subsets_Mito_percent", "sum", "detected"))
#plotExplanatoryVariables(vars)
```
Subset to QC-filtered cells. There appears to be many more cells in the Tsang dataset; however, a similar number of cells (~10%) are filtered based on similar QC metrics.
```{r}
# Keeping the columns we DON'T want to discard.
filtered <- sce.tsang[,!discard]
dropped <- as.numeric(summary(discard)["TRUE"])
kept <- as.numeric(summary(discard)["FALSE"])
print(paste0(dropped, " cells were filtered, yielding ", kept, " remaining cells"))
```
Identify if a rare cell type might have been discarded.
```{r}
lost <- calculateAverage(counts(sce.tsang)[,!discard])
kept <- calculateAverage(counts(sce.tsang)[,discard])

logged <- edgeR::cpm(cbind(lost, kept), log=TRUE, prior.count=2)
logFC <- logged[,1] - logged[,2]
abundance <- rowMeans(logged)
```

Blue points are mitochondrial genes and are expected to be downregulated. Exclusion of a cell type may be indicated by overexpression on this plot, of which there does not appear to be strong overexpression.
```{r}
plot(abundance, logFC, xlab="Average count", ylab="Log-FC (lost/kept)", pch=16)
points(abundance[is.mito], logFC[is.mito], col="dodgerblue", pch=16)
```
Similar differentially expressed genes based on kept/discarded cells as previous samples (lots of MT)
```{r}
# Pull out differentially expressed genes
logFC[logFC < -2]
```

Convert to Seurat object for further preprocessing and analysis and save.
```{r}
tsang <- as.Seurat(filtered)
#saveRDS(tsang, paste0(data_dir, "placenta_scRNA_seq_tsang_filtered_", Sys.Date(), ".rda"))
```

Explore batch effect in tsang samples. There doesn't appear to be much of a batch effect.
```{r}
# Should normalize and find variable features in each dataset separately
tsang <- NormalizeData(object = tsang, normalization.method = "LogNormalize", scale.factor = 10000)
tsang <- FindVariableFeatures(object = tsang)
tsang <- ScaleData(tsang)
tsang <- RunPCA(tsang, features = VariableFeatures(object = tsang))
ElbowPlot(object = tsang, ndims = 100)
DimPlot(tsang, reduction = "pca", group.by = 'orig.ident')
DimPlot(tsang, reduction = "pca", group.by = 'biorep')
```

## QC stats filtering reporting
```{r}
# cbind because cells are on columns and genes are on rows
sce.combined <- cbind(sce, sce.pr, sce.tsang)
sce.combined$sample <- factor(sce.combined$ident, labels = LIBRARY.ID)
```

Number and average number of cells QC-filtered
```{r}
# 47,720 included
sum(table(sce.combined$discard, sce.combined$sample)[1,1:13])
# 3,670.77 per sample 
sum(table(sce.combined$discard, sce.combined$sample)[1,1:13])/13
# 5,636 excluded
sum(table(sce.combined$discard, sce.combined$sample)[2,1:13])
# 433.54 per sample
sum(table(sce.combined$discard, sce.combined$sample)[2,1:13])/13
```

```{r}
sce.meta <- data.frame(
  LIBRARY.ID = sce.combined$sample,
  rna = sce.combined$sum,
  genes = sce.combined$detected,
  mito = sce.combined$subsets_Mito_percent,
  discard = sce.combined$discard
)

qc.supp <- 
  sce.meta %>%
  group_by(LIBRARY.ID) %>%
  summarize(RNA.MOLECULES.MEDIAN = median(rna),
            RNA.MOLECULES.IQR = ceiling(iqr(rna)),
            GENES.MEDIAN = median(genes),
            GENES.IQR = ceiling(iqr(genes)),
            MITO.PERCENT.MEDIAN = round(median(mito), digits = 2),
            MITO.PERCENT.IQR = round(iqr(mito), digits = 2))
cell.count.post.filter <-
  sce.meta %>% 
  group_by(LIBRARY.ID) %>%
  filter(discard == F) %>%
  tally()

qc.supp$CELL.COUNT <- cell.count.post.filter$n

qc.prefilter <- data.frame(LIBRARY.ID, FETAL.SEX, TOTAL.DROPLETS.RAW, TOTAL.RNA.RAW, TOTAL.GENES.RAW, TOTAL.CELLS, FETAL.MATERNAL.DOUBLETS.REMOVED)

QC <- left_join(qc.prefilter, qc.supp)
colnames(QC) <- c("Sample", "Fetal Sex", "Droplets Sequenced", "Total Unique RNA Molecules", "Total Unique Genes Detected", "Total Cells", "Maternal/Fetal Doublets Removed", "Unique RNA Molecules, Median", "Unique RNA Molecules, IQR", "Unique Genes, Median", "Unique Genes, IQR", "Percent Mitochondrial Gene Expression, Median", "Percent Mitochondrial Gene Expression, IQR", "Cells in Final Analytic Sample")

#write.table(x = QC, file = here("results", "single_cell_qc", "scrna_qc_summary.csv"), row.names = F, sep = ",")
```

Subset to only healthy samples
```{r}
sce.combined$orig.ident %>% factor %>% levels
sce.subset <- sce.combined[, !(sce.combined$orig.ident %in% c("tsang_pe1" ,"tsang_pe2", "tsang_pe3", "tsang_pe4")) ,drop=TRUE]
```

```{r}
base.size <- 24

rna.vln <- plotColData(sce.subset, x="sample", y="sum", colour_by="discard") + 
  scale_y_log10() + ggtitle("Total RNA molecules") + theme_bw(base_size = base.size) +
  theme(legend.position = "bottom") +
  guides(colour = guide_legend(override.aes = list(size=20), reverse = TRUE))
#ggsave(here("results", "single_cell_qc", paste0(Sys.Date(), "rna_molecules_by_rep.png")))

gene.vln <- plotColData(sce.subset, x="sample", y="detected", colour_by="discard") + 
        scale_y_log10() + ggtitle("Detected genes") + theme_bw(base_size = base.size)
#ggsave(here("results", "single_cell_qc", paste0(Sys.Date(), "genes_detected_by_rep.png")))

mito.vln <- plotColData(sce.subset, x="sample", y="subsets_Mito_percent", 
        colour_by="discard") + ggtitle("% Mitochondrial genes") + ylab("percentage") + theme_bw(base_size = base.size)
#ggsave(here("results", "single_cell_qc", paste0(Sys.Date(), "percent_mito_by_rep.png")))

legend <- get_legend(rna.vln)
```

Testing to add MAD threshold to each graph
```{r}
base.size <- 24

rna.vln <- plotColData(sce.subset, x="sample", y="sum", colour_by="discard") + 
  scale_y_log10() + ggtitle("Total RNA molecules") +
  #annotate("text", y = 1e5, x = "1B", label = as.character(round(sce.rna.threshold, 1))) + 
  theme_bw(base_size = base.size) +
  theme(legend.position = "bottom") +
  guides(colour = guide_legend(override.aes = list(size=20), reverse = TRUE))

#ggsave(here("results", "single_cell_qc", paste0(Sys.Date(), "rna_molecules_by_rep.png")))

gene.vln <- plotColData(sce.subset, x="sample", y="detected", colour_by="discard") + 
  scale_y_log10() + ggtitle("Detected genes") + theme_bw(base_size = base.size)
#ggsave(here("results", "single_cell_qc", paste0(Sys.Date(), "genes_detected_by_rep.png")))

mito.vln <- plotColData(sce.subset, x="sample", y="subsets_Mito_percent", colour_by="discard") +
  ggtitle("% Mitochondrial genes") + ylab("percentage") + theme_bw(base_size = base.size)
#ggsave(here("results", "single_cell_qc", paste0(Sys.Date(), "percent_mito_by_rep.png")))

legend <- get_legend(rna.vln)
```

```{r}
panel <- ggarrange(rna.vln, gene.vln, mito.vln, ncol = 3, nrow = 1, labels = "AUTO", font.label = list(size = 40, face = "bold", color = "black"), common.legend = TRUE, legend = "bottom", legend.grob = legend)
#ggexport(panel, filename = here("results", "single_cell_qc", paste0(Sys.Date(), "_qc_vlns.png")), width = 1980, height = 1080)
```

# TODO
Clean-up merged object, looks like merging causes duplicate metadata columns
```{r}
# Load in the fully annotated kc, pr Seurat object
kc.pr.analyzed.seu <- readRDS(here("data", "cleaned_combined_seurat_2020-12-22.rda"))
DimPlot(kc.pr.analyzed.seu, group.by = 'cell.type', split.by = "fetal", label = T, repel = T) + NoLegend()
```

```{r}
merged <- merge(kc.pr.analyzed.seu, tsang)
#saveRDS(merged, here("data", paste0("kcprfinal_tsang_qc_merged_", Sys.Date(), ".rda")))
```