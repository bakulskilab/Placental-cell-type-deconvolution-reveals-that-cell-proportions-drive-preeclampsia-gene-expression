---
title: "DESeq2 Analysis of Placenta Sorted Cell Types"
subtitle: "Kyle Campbell - March 14th, 2019"
output: html_document
---

```{r setup, include=FALSE}
# Update R all installed R Packages
# update.packages(ask = FALSE)

library(gprofiler2)
library(here)
library(knitr)
library(pheatmap)
library(RColorBrewer)
library(tidyverse)

library(BiocManager)
library(biomaRt)
library(DESeq2)
library(EnhancedVolcano)
library(GO.db)
library(mygene)
library(org.Hs.eg.db)
library(topGO)

knitr::opts_chunk$set(echo=TRUE)

# May need to update root.dir Drive Letter
#local_data_path <- "C:/Users/k_cam/Google Drive/Placenta_Cell_Types_Kyle/code/R code/local/placenta_sort/dex/data/analysis_datasets/"
```
## Entering Data, Preproccessing, and Model Fitting
```{r DESeq2_object}
# Older file management system
#counts <- readRDS(file =   "./data/analysis_datasets/edgeR_collapsed_counts.Rda")
#meta <- readRDS(file =     "./data/analysis_datasets/edgeR_collapsed_metadata.Rda")
#gene_annotation <- readRDS("./data/analysis_datasets/edgeR_gene_annotation_with_symbols.Rda")

#counts <- readRDS(file =  here("data", "bulk", "edgeR_collapsed_counts.Rda"))
#meta <- readRDS(file = here("data", "bulk", "edgeR_collapsed_metadata.Rda"))
#gene_annotation <- readRDS(here("data", "bulk", "edgeR_gene_annotation_with_symbols.Rda"))

# Must make meta rownames identical to counts colnames
#rownames(meta) <- substr(rownames(meta), 8, 14)

# Creating the DESeq2 experiment object from count data and meta info
#dds <- DESeqDataSetFromMatrix(countData = counts,
#                              colData = meta,
#                              design = ~ 0 + sample.ID + cell.type)

# Adding comprehensive gene annotation to dds
#mcols(dds) <- DataFrame(mcols(dds), gene_annotation)

# NOT using at this point
# Minimal pre-processing to reduce computational load - does NOT represent meaningful filtering
#keep <- rowSums(counts(dds)) >= 10
#dds <- dds[keep,]

# Fitting the model
#dds <- DESeq(dds)
```

Droppping .xx from ENSG IDs for symbol annotation: https://www.biostars.org/p/293965/
Explanation of ENSG vs. ENST: https://www.biostars.org/p/199073/

```{r AddGeneAnnotation}
# Chop off the .xx from the ENSEMBL ID
#row.names(dds) <- substr(x = row.names(dds), start = 1, stop = 15)

#row.names(dds) <- mapIds(org.Hs.eg.db,
#                     keys=row.names(dds),
#                     column="SYMBOL",
#                     keytype="ENSEMBL",
#                     multiVals="first")
```

BiomaRt returns 58,069 of 58,381 gene features from DESeq2 results. Of the 58,069 results, 56,521 return unique external gene names and 58,024 return unique ENSEMBL gene IDs.

```{r biomaRt_DESeq2_results}
# Setting up biomaRt
# Assigning Mart of interest, human ensembl here
#mart = useMart("ensembl",dataset="hsapiens_gene_ensembl")

# Querying biomaRt using gene names to get back ENSEMBL IDs
#DESeq2GeneIDs <- getBM(attributes = c('ensembl_gene_id', 'external_gene_name'),
#             filters = c('ensembl_gene_id'),
#             values = rownames(dds),
#             mart = mart)
#genes.tbl <- as_tibble(DESeq2GeneIDs)

#saveRDS(genes.tbl, here("data", "bulk", "deseq2_gene_symbols.rda"))
# Load gene ids
genes.tbl <- readRDS(here("data", "bulk", "deseq2_gene_symbols.rda"))
```

Save/load 
```{r}
#saveRDS(DESeq2GeneIDs_tbl, "biomaRt_DESeq2_ensembl_ids.rda")
#DESeq2GeneIDs_tbl <- as_tibble(readRDS("biomaRt_DESeq2_ensembl_ids.rda"))
```

```{r SaveLoad}
# Saved the fitted model object to avoid having to reestimate parameters
#saveRDS(dds, file = "./data/analysis_datasets/DESeq2_dds_noint_celltype_sampleid_nofiltering.rda")
#dds <- readRDS(file = "./data/analysis_datasets/DESeq2_dds_noint_celltype_sampleid_nofiltering.rda")

# Load the finished DESeq2 object - note this object has trimmed ensembl IDs
#dds <- readRDS("C:/Users/Kyle/Google Drive/Placenta_Cell_Types_Kyle/code/R code/local/placenta_sort/dex/data/analysis_datasets/DESeq2_dds_noint_celltype_sampleid_nofiltering.rda")

#dds <- readRDS(paste0(local_data_path, "/DESeq2_dds_noint_celltype_sampleid_nofiltering.rda"))

dds <- readRDS(here("data", "bulk", "DESeq2_dds_noint_celltype_sampleid_nofiltering.rda"))
```

Ideas for how to deal with multiple Ensembl IDs mapping to a single gene symbol
https://www.researchgate.net/post/How-to-deal-with-multiple-ensemble-IDs-mapping-to-one-gene-symbol-in-a-RNA-Seq-dataset

## Comparing cell type-specific gene expression to the average expression level across other cell types

Our first contrast of interest is how cell type-specific expression differs vs. the average expression across all other cell types. [This thread](https://support.bioconductor.org/p/118090/) recommends fitting a no-intercept model to answer this question. [Another thread](https://support.bioconductor.org/p/86347/) contains a brief discussion of how to code it. These contrasts will exclude the composite tissue group. I wonder if excluding the composite samples from normalization and filtering is appropriate for this particular set of comparisions. I think that also depends on whether we use the composite samples in any analyses.

Modernized code (3/2021) and outstanding questions:
1. Include composite samples in model for gene variance moderation or drop?
  a. Emprically test running with and without
2. Include endothelial in the cell type comparison group?
  a. Empirically test
    i. Stable model either way (fewer hits than CT)
3. Handling Ensembl ID/HGNC symbol multimapping
  a. previously handled at annotating results stage (when DESeq2 vignette does it)

Note: in DESeq2 alpha is the FDR-adjusted significance cutoff
``` {r}
run_deseq2 <- function(target, dds) {
  
  # Print current target
  print(target)
  
  # Set alpha
  alpha <- .05
  
  # List coefficients
  cell.types <-
    c(
      "cell.typecytotrophoblast",
      "cell.typeendothelial",
      "cell.typeextravilloustrophoblast",
      "cell.typefibroblast",
      "cell.typehofbauer",
      "cell.typeleukocyte",
      "cell.typesyncytiotrophoblast"
    )
  
  # Select contrast coefficients based on cell type input
  coef <- cell.types[grepl(target, cell.types)]
  inv.coef <- cell.types[!grepl(target, cell.types)]
  
  # For the DESeq2 results() call in this chunk:
  # The first vector is our cell type of interest
  # Create the contrast of interest
  # The following vector contains comparison group
  # listValues Specifies comparision against average expression across other groups
  # Pull contrast of interest
  results <- results(
    dds,
    contrast = list(coef,
                    inv.coef),
    listValues = c(1,-1 / 6),
    alpha = alpha
  )
  
  # Summarize DESeq2 filtering
  summary <- summary(results)
  print(
    paste0(
      summary(is.na(results$padj))[3],
      " features dropped due to independent filtering, all zero counts, or extreme outlier status in DESeq2"
    )
  )
  
  # Coerce DESeq2 Results to df
  res.df <- as.data.frame(results)
  
  # Move gene ensembl IDs from row to table column
  res <- rownames_to_column(res.df, "ensembl_gene_id")
  
  # Remove dropped genes from results
  res <-
    res %>%
    filter(!is.na(padj))
  
  # Add gene annotation and drop duplicate gene names
  res <- left_join(res, genes.tbl) %>%
    dplyr::select(external_gene_name, everything()) %>%
    relocate(ensembl_gene_id, .after = last_col())
  
  # Print the small number of duplicated genes after DESeq2 auto filtering. Most are SNORNAs and many are vague Y_RNA, rRNA, metazoa RNA, etc.
  duplicated.genes <-
    res %>%
    group_by(external_gene_name) %>%
    tally() %>%
    filter(n > 1)
  print(paste0(dim(duplicated.genes)[1], " duplicated gene symbols dropped"))
  
  # Drop duplicated genes after DESeq2 auto filtering
  res <-
    res %>%
    group_by(external_gene_name) %>%
    filter(!(n() > 1)) %>%
    as_tibble()
  
  # Rename gene symbol column from "external_gene_name" to "gene_symbol"
  res <-
    res %>%
    mutate(gene_symbol = external_gene_name) %>%
    dplyr::select(-external_gene_name)
  
  res <-
    res %>%
    dplyr::select(gene_symbol,
                  baseMean,
                  log2FoldChange,
                  lfcSE,
                  stat,
                  pvalue,
                  padj,
                  ensembl_gene_id)
  
  # Get and arrange upreg
  upreg <-
    res %>%
    filter(padj < alpha) %>%
    filter(log2FoldChange > 0) %>%
    arrange(desc(log2FoldChange))
  
  # Get and arragne downreg
  downreg <-
    res %>%
    filter(padj < alpha) %>%
    filter(log2FoldChange < 0) %>%
    arrange(desc(abs(log2FoldChange)))
  
  # Number of top downregulated and upregulated genes to label on Volcano plot
  num.to.plot <- 10
  
  # Option to manually label a vector of genes
  genes.of.interest <- NULL
  
  # Create label dummy to decide if gene labelled on Volcano plot
  top.upreg <- upreg$gene_symbol[1:num.to.plot]
  top.downreg <- downreg$gene_symbol[1:num.to.plot]
  genes.to.plot <- c(top.upreg, top.downreg, genes.of.interest)
  res$label[(res$gene_symbol %in% genes.to.plot)] <- T
  
  # Add significance indicator variable for plotting
  res <-
    res %>%
    mutate(sig = ifelse(padj < alpha,
                        T,
                        F))
  # Volcano plot
  plot <- ggplot(res) +
    geom_point(aes(
      x = log2FoldChange,
      y = -log10(padj),
      colour = sig
    )) +
    geom_text_repel(aes(
      x = log2FoldChange,
      y = -log10(padj),
      label = ifelse(label, gene_symbol, "")
    ),
    max.overlaps = Inf) +
    geom_hline(yintercept = -log10(alpha), linetype = "dotted") +
    ggtitle("Contrast of Interest") +
    xlab("log2 fold change") +
    ylab("-log10 adjusted p-value") +
    theme(
      legend.position = "none",
      plot.title = element_text(size = rel(1.5), hjust = 0.5),
      axis.title = element_text(size = rel(1.25))
    ) +
    labs(caption = paste0(
      dim(res)[1],
      " total genes (",
      summary(is.na(results$padj))[3],
      " dropped from contrast)"
    ))
  
  # Create a label dataframe for geom_label annotation
  label.df <- data.frame(
    label = paste0(dim(upreg)[1], " upregulated genes\n", paste0(dim(downreg)[1], " downregulated genes")),
    x = Inf,
    y = Inf,
    hjustvar = 1,
    vjustvar = 1
  )
  
  # Add geom_label annotation
  plot <-
    plot + geom_label(data = label.df,
                      aes(
                        x = x,
                        y = y,
                        label = label,
                        hjust = hjustvar,
                        vjust = vjustvar
                      ))
  plot

  returnList <- list("res" = res,
                     "volcano" = plot,
                     "duplicated.genes" = duplicated.genes)
  return(returnList)
}

cell.types <-
    list(
      "cytotrophoblast",
      "endothelial",
      "extravilloustrophoblast",
      "fibroblast",
      "hofbauer",
      "leukocyte",
      "syncytiotrophoblast"
    )

mapped <- lapply(cell.types, run_deseq2, dds = dds)
names(mapped) <- cell.types
```

```{r}
# Input ggplot to get x and y limits for graph
get_coord_limits <- function(ggplot) {
  
  # Get build options
  build <- ggplot_build(ggplot)
  # Get x-limits
  x <- build$layout$panel_scales_x[[1]]$range$range
  # Get y-limits
  y <- build$layout$panel_scales_y[[1]]$range$range
  
  # Return x and y limits as list
  return(list(
    "x" = x,
    "y" = y
  ))
}

# Pull limits from each graph
limits <- map(mapped, ~ get_coord_limits(.x[["volcano"]]))

# Pull x-limits and convert to list of vectors
x_limits <- map(limits, ~ unlist(.x["x"]))
# Convert x-limits to vector
x_limits <- unlist(x_limits)
# Get x-min
x_min <- min(x_limits)
# Get x-max
x_max <- max(x_limits)

# Pull y-limits and convert to list of vectors
y_limits <- map(limits, ~ unlist(.x["y"]))
# Convert y-limits to vector
y_limits <- unlist(y_limits)
# Get y-min
y_min <- min(y_limits)
# Get y-max
# y-max for ST is 1e-60, going to use 2nd largest value instead for graph readibility
y_sorted <- sort(y_limits)
y_max <- y_sorted[length(y_sorted)-3] %>% as.numeric
#y_max <- max(y_limits)

names(mapped)
contrast.labels <- c("Cytotrophoblast" , "Endothelial", "Extravillous Trophoblast", "Fibroblast", "Hofbauer Cell", "Leukocyte", "Syncytiotrophoblast")

# Get presentable volcanos
# Add contrast title and set x and y limits without removing data points
volcanos <- map2(mapped, contrast.labels, ~ .x[["volcano"]] + ggtitle(.y) + coord_cartesian(xlim = c(x_min, x_max), ylim = c(y_min, y_max)))

# Custom function to save ggplots
save_plot <- function(plot, filename) {
  print(plot)
  ggsave(
    here("results", "bulk", paste0(filename, "_volcano_", Sys.Date(), ".png"))
  )
}
# Save volcanos
#map2(volcanos, names(mapped), ~ save_plot(.x, .y))
```

```{r}
volcanos$cytotrophoblast
```


``` {r cyto_vs_all}
# Get Cytotrophoblast results
 ct.res <- SummarizeDESeq2Results(cytovall_res, "Cytorophoblasts", .005)

# GO analysis
# Create the numeric vector FDR-adjusted p-values from DESeq2 DEX output, remove missing p-vals from DESEq2, and name list with genes for topGO input
ctGenes <- ct.res$padj
names(ctGenes) <- rownames(ct.res)
ctGenes <- na.omit(ctGenes)
str(ctGenes)

# Define a function for padj cutoff selection
topDiffGenes <- function(allScore) {
  return(allScore < 0.05)
}

# Constructing the topGOdata object for downstream analysis
ctGOdata <- new("topGOdata",
                ontology = "BP",
                allGenes = ctGenes,
                geneSelectionFun = topDiffGenes,
                nodeSize = 10,
                annot = annFUN.org,
                mapping = "org.Hs.eg.db",
                ID = "ensembl")

# Running the enrichment test using the weight01Score method because weight method accounts for GO topology and therefore accoutns for multiple testing. Score method to employ the nonparametric Kolmogorov-Smirnov test based on gene rank (also known as GSEA)
test.stat <- new(Class = "weight01Score", testStatistic = GOKSTest, name = "Weight01 KS tests")

# getSigGroups returns an object of class 'topGOresult', here named resultweight01KS to reflect test employed
resultweight01KS <- getSigGroups(ctGOdata, test.stat)

# Already performed in dataset
# # Chop off the .xx from the ENSEMBL ID
# row.names(res) <- substr(x = row.names(res), start = 1, stop = 15)
# 
# # Add gene symbols
# res$symbol <- mapIds(org.Hs.eg.db,
#                      keys=row.names(res),
#                      column="SYMBOL",
#                      keytype="ENSEMBL",
#                      multiVals="first")
plotMA(res)
summary(res)

res_df <- as.data.frame(res)
dim(res_df) #58381 genes
summary(res_df$pvalue) #8862 missing, with zero counts in all conditions
length(res_df$stat[res_df$stat==0]) #14208 that have test statistics of 0, independent filtered out?
58381 - 8862 - 14208 #35311 total genes used in this contrast

testd <- res_df %>%
  filter(padj < .05) %>%
  arrange(desc(baseMean), desc(log2FoldChange))

testd <- as_tibble(testd)
testd <- rename(testd, scGenes = symbol)

testleftjoin <- left_join(scGenes_df, testd, by = "scGenes")
testleftjoin %>%
  arrange(desc(baseMean), desc(log2FoldChange))
testleftjoin <- drop_na(testleftjoin)
#write.csv(x = testleftjoin, file = "CTvsAll_alpha005_scOverlap.csv")

```
### Cytotrophoblast vs. All Volcano Plot
```{r cytovall_volcano, echo = FALSE}
    EnhancedVolcano(res,
        lab = res$symbol,
        x = "log2FoldChange",
        y = "padj",
        
        xlab = bquote(~Log[2]~ "fold change"),
        ylab = bquote(~-Log[10]~adjusted~italic(P)),
        
        pCutoff = .005,
        FCcutoff = 2.0,
        
        #transcriptPointSize = 1.5,
        #transcriptLabSize = 3.0,
        colAlpha = 1,
        
        title = "Cytotrophoblast vs. Others",
        
        legend=c("NS","Log2 FC","Adjusted p-value",
                 "Adjusted p-value & Log2 FC"),
        legendPosition = "bottom",
        legendLabSize = 10,
        legendIconSize = 3.0,
        
        drawConnectors = FALSE,
        widthConnectors = 0.2,
        colConnectors = "grey30"
        )
```

``` {r hb_vs_all}
# Create the contrast of interest
# The first vector is our cell type of interest
# The following vector contains comparison group
# listValues Specifies comparision against average expression across other groups
hbvall_res <- results(dds,
               contrast = list( c("cell.typehofbauer"),
                                c("cell.typeendothelial",
                                  "cell.typeextravilloustrophoblast",
                                  "cell.typefibroblast",
                                  "cell.typecytotrophoblast",
                                  "cell.typesyncytiotrophoblast")),
               listValues = c(1, -1/5),
               alpha = 0.05
               )
# Rename to res for easy replication of DESeq2 vignette code
res <- hbvall_res

# Chop off the .xx from the ENSEMBL ID
row.names(res) <- substr(x = row.names(res), start = 1, stop = 15)

# Add gene symbols
res$symbol <- mapIds(org.Hs.eg.db,
                     keys=row.names(res),
                     column="SYMBOL",
                     keytype="ENSEMBL",
                     multiVals="first")
plotMA(res)
summary(res)

res_df <- as.data.frame(res)
dim(res_df) #58381 genes
summary(res_df$pvalue) #8862 missing, with zero counts in all conditions
length(res_df$stat[res_df$stat==0]) #12023 that have test statistics of 0, independent filtered out?
58381 - 8862 - 12023 #37496 total genes used in this contrast

testd <- res_df %>%
  filter(padj < .005) %>%
  arrange(desc(baseMean), desc(log2FoldChange))

testd <- as_tibble(testd)
testd <- rename(testd, scGenes = symbol)

testleftjoin <- left_join(scGenes_df, testd, by = "scGenes")
testleftjoin %>%
  arrange(desc(baseMean), desc(log2FoldChange))
testleftjoin <- drop_na(testleftjoin)
write.csv(x = testleftjoin, file = "HBvsAll_alpha005_scOverlap.csv")

```

```{r hbvall_volcano, echo = FALSE}
    EnhancedVolcano(res,
        lab = res$symbol,
        x = "log2FoldChange",
        y = "padj",
        
        xlab = bquote(~Log[2]~ "fold change"),
        ylab = bquote(~-Log[10]~adjusted~italic(P)),
        
        pCutoff = 0.05,
        FCcutoff = 2.0,
        
        transcriptPointSize = 1.5,
        transcriptLabSize = 3.0,
        colAlpha = 1,
        
        legend=c("NS","Log2 FC","Adjusted p-value",
                 "Adjusted p-value & Log2 FC"),
        legendPosition = "bottom",
        legendLabSize = 10,
        legendIconSize = 3.0,
        
        drawConnectors = FALSE,
        widthConnectors = 0.2,
        colConnectors = "grey30",
        
        title = "Hofbauer Cells vs. Others")
```

``` {r fb_vs_all}
# Create the contrast of interest
fbvall_res <- results(dds,
               contrast = list( c("cell.typefibroblast"), # The first vector is our cell type of interest
                                c("cell.typeendothelial",  # The following vector contains comparison group
                                  "cell.typeextravilloustrophoblast",
                                  "cell.typehofbauer",
                                  "cell.typecytotrophoblast",
                                  "cell.typesyncytiotrophoblast")),
               listValues = c(1, -1/5) # Specifies comparision against average expression across other groups
               )
# Rename to res for easy replication of DESeq2 vignette code
res <- fbvall_res

# Chop off the .xx from the ENSEMBL ID
x <- substr(x = row.names(res), start = 1, stop = 15)

# Add gene symbols
res$hgnc_symbol <- convertIDs( x, "ENSEMBL", "SYMBOL", org.Hs.eg.db)

plotMA(res)
summary(res)

results_df <- as.data.frame(res)

results_df %>%
  filter(hgnc_symbol=="COL1A1")



# Create the contrast of interest
fbvall_res <- results(dds,
               contrast = list( c("cell.typefibroblast"), # The first vector is our cell type of interest
                                c("cell.typeendothelial",      # The following vector contains comparison group
                                  "cell.typeextravilloustrophoblast",
                                  "cell.typehofbauer",
                                  "cell.typecytotrophoblast")),
               listValues = c(1, -1/4) # Specifies comparision against average expression across other groups
               )
# Rename to res for easy replication of DESeq2 vignette code
res <- fbvall_res

# Chop off the .xx from the ENSEMBL ID
x <- substr(x = row.names(res), start = 1, stop = 15)

# Add gene symbols
res$hgnc_symbol <- convertIDs( x, "ENSEMBL", "SYMBOL", org.Hs.eg.db)

plotMA(res)
summary(res)

results_df <- as.data.frame(res)

results_df %>%
  filter(hgnc_symbol=="COL1A1")
```

``` {r e}
counts_test <- counts
counts_test$hgnc_symbol <- convertIDs(x, "ENSEMBL", "SYMBOL", org.Hs.eg.db)
COL1A1 <- counts_test %>%
  filter(hgnc_symbol=="COL1A1")
COL1A1 <- COL1A1[,1:24]
col1a1 <- as.data.frame(COL1A1)
col1a1[2,] <- names(col1a1)

tes <- data.frame()#data.frame(reads=integer(col1a1[1,]), samples = factor(names(col1a1)))
tes$samples <- names(col1a1)
tes$reads <- col1a1[1,]

a <- ggplot(col1a1, aes(x = col1a1[2,], y = col1a1[1,]))
a + geom_col()

#write.csv(col1a1, )
```


```{r fbvall_volcano, echo = FALSE}
    EnhancedVolcano(res,
        lab = res$hgnc_symbol,
        x = "log2FoldChange",
        y = "padj",
        
        selectLab = "ENSG00000108821",
        
        xlab = bquote(~Log[2]~ "fold change"),
        ylab = bquote(~-Log[10]~adjusted~italic(P)),
        
        pCutoff = .1,
        FCcutoff = 1.0,
        
        transcriptPointSize = 1.5,
        transcriptLabSize = 3.0,
        colAlpha = 1,
        
        legend=c("NS","Log2 FC","Adjusted p-value",
                 "Adjusted p-value & Log2 FC"),
        legendPosition = "bottom",
        legendLabSize = 10,
        legendIconSize = 3.0,
        
        drawConnectors = FALSE,
        widthConnectors = 0.2,
        colConnectors = "grey30",
        
        title = "Fibroblast Cells vs. Others")
```



## Data Quality Assessment by Clustering and Visualization

We'll begin by transforming the data to the log-fold-2 scale using the same shrinkage transformation employed in the DEX pipeline.

```{r transformation}
#rld <- rlog(dds, blind = TRUE)
#saveRDS(rld, file = paste0(local_data_path, "DESeq2_rld.rda"))
#saveRDS(rld, here("data", "bulk", paste0(Sys.Date(), "DESeq2_rld.rda")))
#rld <- readRDS(file = paste0(local_data_path, "DESeq2_rld.rda"))
rld <- readRDS(here("data", "bulk", "2021-03-26DESeq2_rld.rda"))
```
103911 - leukocyte is an extreme outlier on blind PCA analysis, will remove and rerun. PCA looks similar with 103911 - leukocyte removed
```{r}
#dds_103911 <- dds[,colnames(dds) != "103911"]
#dds_103911 <- DESeq(dds_103911)
#rld <-rlog(dds_103911, blind = TRUE)
```
### Hierarchical Clustering Heatmap
```{r hc_heatmap}
# Calculate sample distances
sampleDists <- dist(t(assay(rld)))

# Hierarchical heatmap clustering - DESeq2 vignette
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(rld$cell.type, rld$sample.ID, rld$is.Paired, sep="-")
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         col=colors)
```
### PCA Plot
```{r rld_pca}
# Customized PCA ggplot
pcaData <- plotPCA(rld, intgroup=c("cell.type", "sample.ID"), returnData=TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))
ggplot(pcaData, aes(PC1, PC2, color=cell.type, shape=sample.ID)) +
  geom_point(size=3.5) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
  coord_fixed()
#ggsave(sprintf("%sSorted_PCA.png", local_output_path), device = "png")
```