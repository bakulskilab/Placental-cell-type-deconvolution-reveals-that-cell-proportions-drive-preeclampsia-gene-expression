---
title: "Comparing placental bulk- and scRNA-seq"
output: html_document
---

```{r setup, include=FALSE}
library(here)
library(tidyverse)
library(corrplot)
library(ggplot2)
library(ggridges)
library(ggrepel)
library(Seurat)
library(cowplot)
library(rgl)
library(EnvStats)
library(reticulate)
library(clustree)
library(BiocManager)
# Must install the following packages using BiocManager, e.g. > BiocManager::install("org.Hs.eg.db")
library(org.Hs.eg.db)
library(biomaRt)
library(DESeq2)
library(mygene)
knitr::opts_chunk$set(echo = TRUE)
```

Not really feasible to compare the two at all, https://www.biostars.org/p/399869/. Batch effect would be larger than biological effect and no way to control for that.

```{r ImportData}
seu <- readRDS(here("data", "cleaned_combined_seurat_2020-12-22.rda"))
dds <- readRDS(here("data", "bulk", "2021-04-16_dds_prefiltered.rda"))

# Import bulk data gene list already retrieved during the DESeq2 differential expression analysis; don't need
#dds.genes <- readRDS(here("data", "bulk", "deseq2_gene_symbols.rda"))
```

Normalized Seurat single-cell counts are stored in the "data" slot of the "RNA" field of the "assay" slot. Here we use biomaRt to collect ENSEMBL gene IDs using gene names stored in the Seurat object.

```{r biomaRtGeneIDs}
# Setting up biomaRt
# Assigning Mart of interest, human ensembl here
#mart <- useMart("ensembl",dataset="hsapiens_gene_ensembl")

# # Alternative because biomaRt connection unavailable above
# mart <- useEnsembl(biomart = "ensembl", dataset = 'hsapiens_gene_ensembl', host = "uswest.ensembl.org")
# 
# # Querying biomaRt using gene names to get back ENSEMBL IDs
# scGeneIDs <- getBM(attributes = c('ensembl_gene_id', 'external_gene_name'),
#              filters = c('external_gene_name'),
#              values = rownames(seu@assays$RNA@data),
#              mart = mart)
# genes.sc <- as_tibble(scGeneIDs)

#saveRDS(genes.sc, here("data", "bulk", "biomaRt_single-cell_2021-04-21.rda"))
genes.sc <- readRDS(here("data", "bulk", "biomaRt_single-cell_2021-04-21.rda"))
# 36601 genes in single-cell data
length(rownames(seu@assays$RNA@data))
# biomaRt query returned 38886 gene IDs
dim(genes.sc)
```

No duplicate IDs
```{r}
genes.sc %>%
  group_by(ensembl_gene_id) %>%
  filter(n() > 1)
```

Check for duplicate gene names
```{r}
genes.sc %>%
  group_by(external_gene_name) %>%
  filter(n() > 1)
```

```{r}
# Function arguments
seuratObject <- seu
clusterIdentity <- "Fetal Hofbauer Cells"
biomaRtList <- genes.sc

# Helper code to write out the long strings required for RenameIdents() input
#base::paste(idents, collapse = " = Leukocytes, ")

seu <- SetIdent(seu, value = "cell.type")
levels(seu)

# Grouping Mesenchymal Stem Cells with Fibroblast since the Flow sorting for the bulk samples does not distinguish between the two based on single-cell expression data
seu <- RenameIdents(seu,
             "Fetal B Cells" = "Leukocytes",
             "Fetal CD14+ Monocytes" = "Leukocytes",
             "Fetal CD8+ Cytotoxic T Cells" = "Leukocytes",
             "Fetal Cytotrophoblasts" = "Cytotrophoblast",
             "Fetal Endothelial Cells" = "Endothelial",
             "Fetal Extravillous Trophoblasts" = "Extravillous Trophoblast",
             "Fetal Fibroblasts" = "Fibroblast",
             "Fetal GZMB+ Natural Killer" = "Leukocytes",
             "Fetal GZMK+ Natural Killer" = "Leukocytes",
             "Fetal Hofbauer Cells" = "Hofbauer Cell",
             "Fetal Memory CD4+ T Cells" = "Leukocytes",
             "Fetal Mesenchymal Stem Cells" = "Fibroblast",
             "Fetal Naive CD4+ T Cells" = "Leukocytes",
             "Fetal Naive CD8+ T Cells" = "Leukocytes",
             "Fetal Natural Killer T Cells" = "Leukocytes",
             "Fetal Nucleated Red Blood Cells" = "Fetal Nucleated Red Blood Cells",
             "Fetal Plasmacytoid Dendritic Cells" = "Leukocytes",
             "Fetal Proliferative Cytotrophoblasts" = "Cytotrophoblast",
             "Fetal Syncytiotrophoblast" = "Syncytiotrophoblast",
             "Maternal B Cells" = "Leukocytes",
             "Maternal CD14+ Monocytes" = "Leukocytes",
             "Maternal CD8+ Cytotoxic T Cells" = "Leukocytes",
             "Maternal FCGR3A+ Monocytes" = "Leukocytes",
             "Maternal Naive CD4+ T Cells" = "Leukocytes",
             "Maternal Naive CD8+ T Cells" = "Leukocytes",
             "Maternal Natural Killer Cells" = "Leukocytes",
             "Maternal Plasma Cells" = "Leukocytes")

# Stash collapse cell type groups under a variable called collpase 
seu <- StashIdent(seu, "collapse")

# Calculate AverageExpression by cell type group
# WARNING: by default, returns in non-log space
gex.sc.average <- AverageExpression(seu, group.by = "collapse", slot = "data")

# Converting Seurat Normalized expression matrix to a dataframe for gene ID annotation
cluster.df <- as.data.frame(gex.sc.average)

cluster.df <- cluster.df %>%
  mutate_all(l)

cluster.df <- rownames_to_column(cluster.df, var = "external_gene_name")
```

Double-check how featureCounts or DESeq2 handles gene IDs mapping to multiple haplotypes (could also just choose the standard haplotype but don't know of a way of doing without manually looking up IDs, perhaps someone has a list, going to ignore for now), noticing a lot of the same expression values with each multimapping gene symbol. Discussion of disambiguation https://www.researchgate.net/post/How-to-deal-with-multiple-ensemble-IDs-mapping-to-one-gene-symbol-in-a-RNA-Seq-dataset - taking the highest expression value seems the easiest. Another practical thread: https://www.biostars.org/p/389804/. Genes in haplotypic regions are the most likely reason for duplicate IDs mapping to one symbol https://www.biostars.org/p/119540/. 
```{r}
# Join sc expression matrix and gene IDs
gex.sc <-
  as_tibble(left_join(x = cluster.df, y = biomaRtList))

gex.sc %>%
  group_by(external_gene_name) %>%
  tally %>%
  filter (n > 1)

gex.sc %>%
  filter(is.na(external_gene_name))

dim(gex.sc)

# Take max expression value of the multiple ensembl gene IDs mapping to the same external gene name
gex.sc.unique <- 
  gex.sc %>%
  group_by(external_gene_name) %>%
  summarise(across(contains("RNA"), ~ max(.x))) # Operate colwise on all column names that contain "RNA" and take max of non-unique external_gene_names
dim(gex.sc.unique)

# Drop the Fetal Nucleated Red blood cells since we're not using that
gex.sc.unique <- gex.sc.unique %>%
  dplyr::select(!RNA.Fetal.Nucleated.Red.Blood.Cells)
```

Calculating normalized DESeq2 counts from the sorted data and subsetting to relevant cell type populations (https://support.bioconductor.org/p/66067/ for reference).

```{r BulkNormalizedCounts}
# Calculate normalized counts from bulk RNA-seq DESeq2 object (code from thread above)
bulk.normalized <- as.data.frame(counts(dds, normalized = T))
#bulk.normalized <- rownames_to_column(bulk.normalized, "ensembl_gene_id")
# Want to emulate normalization used in Seurat. Seurat performs library size normalization and then log1p transforms the result using the natural log.
bulk.norm.elog <- 
  bulk.normalized %>%
  mutate_all(log1p)
rownames(bulk.norm.elog) <- rownames(bulk.normalized)
bulk.normalized <- bulk.norm.elog
```

```{r AnnotateBulkNormalized}
# Querying biomaRt using gene names to get back ENSEMBL IDs
# bulkGeneIDs <- getBM(attributes = c('ensembl_gene_id', 'external_gene_name'),
#              filters = c('ensembl_gene_id'),
#              values = rownames(bulk.normalized),
#              mart = mart)
# genes.bulk <- as_tibble(bulkGeneIDs)
# dim(genes.bulk)

#saveRDS(genes.bulk, here("data", "bulk", "biomaRt_bulk_2021-04-21.rda"))
genes.bulk <- readRDS(here("data", "bulk", "biomaRt_bulk_2021-04-21.rda"))

bulk.gex <- rownames_to_column(bulk.normalized, var = "ensembl_gene_id")
bulk <- left_join(bulk.gex, genes.bulk, by = "ensembl_gene_id")
dim(bulk)

missing <- bulk %>%
  filter(is.na(external_gene_name)) %>%
  tally
print(paste0(missing$n, " missing external gene name annotations in bulk data dropped"))

bulk <- bulk %>%
  filter(!is.na(external_gene_name))
dim(bulk)
```

```{r}
# Take max expression value of the multiple ensembl gene IDs mapping to the same external gene name
bulk.unique <- 
  bulk %>%
  group_by(external_gene_name) %>%
  summarise(across(where(is.numeric), ~ max(.x))) # Operate colwise on all numeric cols and take max of non-unique
dim(bulk.unique)

# Return external_gene_name to rownames slot
bulk.unique <- column_to_rownames(bulk.unique, var = "external_gene_name")
```

```{r BulkSubset}
ct.bulk        <- bulk.unique[,c( "103905", "105816")]
composite.bulk <- bulk.unique[,c( "103900", "103908", "103916", "105819", "105820")]
# Need to add drop = FALSE to prevent conversion to vector
en.bulk        <- bulk.unique[,c( "103915"), drop = FALSE]
et.bulk        <- bulk.unique[,c( "103904", "103912", "105815")]
fb.bulk        <- bulk.unique[,c( "103906", "103914", "105817")]
hb.bulk        <- bulk.unique[,c( "103894", "103902", "103910", "105813")]
lk.bulk        <- bulk.unique[,c( "103903", "103911", "105814")]
st.bulk        <- bulk.unique[,c( "103893", "105812")]
```

```{r BulkSubset}
# ct.bulk        <- bulk.unique[,c("external_gene_name", "103905", "105816")]
# composite.bulk <- bulk.unique[,c("external_gene_name", "103900", "103908", "103916", "105819", "105820")]
# # Need to add drop = FALSE to prevent conversion to vector
# en.bulk        <- bulk.unique[,c("external_gene_name", "103915"), drop = FALSE]
# et.bulk        <- bulk.unique[,c("external_gene_name", "103904", "103912", "105815")]
# fb.bulk        <- bulk.unique[,c("external_gene_name", "103906", "103914", "105817")]
# hb.bulk        <- bulk.unique[,c("external_gene_name", "103894", "103902", "103910", "105813")]
# lk.bulk        <- bulk.unique[,c("external_gene_name", "103903", "103911", "105814")]
# st.bulk        <- bulk.unique[,c("external_gene_name", "103893", "105812")]
```

```{r}
bulk <- 
  tibble(
  external_gene_name = rownames(bulk.unique),
  ct.bulk %>%
    rowwise() %>%
    summarize(bulk.cytotrophoblast = mean(c_across(where(
      is.numeric
    )))),
  composite.bulk %>%
    rowwise() %>%
    summarize(bulk.composite = mean(c_across(where(
      is.numeric
    )))),
  bulk.endothelial = en.bulk$`103915`,
  et.bulk %>%
    rowwise() %>%
    summarize(bulk.extravilloustrophoblast = mean(c_across(where(
      is.numeric
    )))),
  fb.bulk %>%
    rowwise() %>%
    summarize(bulk.fibroblast = mean(c_across(where(
      is.numeric
    )))),
  hb.bulk %>%
    rowwise() %>%
    summarize(bulk.hofbauer = mean(c_across(where(
      is.numeric
    )))),
  lk.bulk %>%
    rowwise() %>%
    summarize(bulk.leukocyte = mean(c_across(where(
      is.numeric
    )))),
  st.bulk %>%
    rowwise() %>%
    summarize(bulk.syncytiotrophoblast = mean(c_across(where(
      is.numeric
    ))))
)
```

```{r}
gex.sc.unique %>% dim
bulk %>% dim
```

Join gene symbols that are in both datasets
```{r}
joint <- inner_join(gex.sc.unique, bulk, by = "external_gene_name")
dim(joint)
```

```{r}
data.cor <- (column_to_rownames(joint, var = "external_gene_name"))
# Compute a correlation matrix
corr <- round(cor(data.cor), 3)
corr.spearman <- round(cor(data.cor, method = "spearman"), 3)
```

```{r}
#dev.new()
#pdf(paste0(results_dir, "cell_type_props_corrplot_", Sys.Date(), ".pdf"))
corrplot(corr, method = "ellipse", order = "hclust", tl.cex = .7) #tl.cex control axis label size
corrplot(corr.spearman, method = "ellipse", order = "hclust", tl.cex = .7) #tl.cex control axis label size
#dev.off()

# Alternative options
#corrplot(corr, method = "ellipse", order = "hclust")
#corrplot(corr, method = "ellipse", order = "AOE")
```

```{r}
exprCorrelation <- function(df, string) {
  
  # Store the string for a ggplot title
  title <- string
  
  # Take only the first word for matching purposes
  string <- word(string)
  
  # Subset the dataset to the two relevant columns
  pair <- df %>% dplyr::select(contains(string))
  
  # Calculate Pearson and Spearman correlation coefficients
  pearson <- cor(pair[,1], pair[,2], method = c("pearson")) %>% as.numeric %>% round(digits = 2)
  spearman <- cor(pair[,1], pair[,2], method = c("spearman")) %>% as.numeric %>% round(digits = 2)
  
  #print(paste0(pearson, " pearson correlation"))
  #print(paste0(spearman, " spearman correlation"))
  
  # Find the colnames that match the input
  match.indices <- grep(pattern = string, x = names(joint), ignore.case = TRUE)
  var <- names(joint)[match.indices]
  
  # Plot single-cell and bulk expression
  plot <- ggplot(joint) + aes_string(x = var[1], y = var[2]) + geom_point(alpha = .3) + labs(subtitle = paste0("\U03C1 = ", spearman, ", r = ", pearson)) + xlab("Single-cell Expression") + ylab("Bulk") + ggtitle(title) + theme_bw(base_size = 20)
  
  # Save plots
  #ggsave(here("results", "bulk", "correlation", paste0(Sys.Date(), string, "_correlation.png")), width = 7, height = 7)
  
  #print(plot)
  
  return(plot)
}

contrast.labels <- c("Cytotrophoblast" , "Endothelial", "Extravillous Trophoblast", "Fibroblast", "Hofbauer Cell", "Leukocyte", "Syncytiotrophoblast")

plots <- map(contrast.labels, ~ exprCorrelation(joint, .x))
```

```{r}
print(plots)
```

Optimal file export settings are much different from display in R
```{r}
panel <- ggarrange(plots[[1]], plots[[2]], plots[[3]], plots[[4]], plots[[5]], plots[[6]], plots[[7]], ncol = 4, nrow = 2, labels = "AUTO", font.label = list(size = 24, face = "bold", color = "black"))
#print(panel)
# Works okay with theme_bw(base_size = 20) and font.label size = 24 in ggarrange
ggexport(panel, filename = here("results", "bulk", "correlation", paste0(Sys.Date(), "_correlation_multipanel.png")), width = 1920, height = 1080)
```

```{r}
cow <- plot_grid(plotlist = plots, labels = "AUTO", nrow = 4, ncol = 2, align = "hv")
print(cow)
```


```{r}
smoothScatter(joint$RNA.Cytotrophoblast, joint$bulk.cytotrophoblast)
```


``` {r ManualImplementation}
ct.sc.gex <- getSeuratClusterNormExpressionMatrix(seuratObject = sc.placenta,
                                                  clusterIdentity = "Cytotrophoblast",
                                                  biomaRtList = scGeneIDs.tbl)

ct.ids <- WhichCells(object = sc.placenta, idents = "Cytotrophoblast")
ct.sc <- subset(x = sc.placenta, cells = ct.ids)
ct.sc.df <- as.data.frame(ct.sc@assays$RNA@data)
ct.sc.df <- rownames_to_column(ct.sc.df)
colnames(ct.sc.df)[1] <- 'external_gene_name'
ct.sc.df <- as_tibble(ct.sc.df)

# Sort
ct.sc.df <- ct.sc.df %>%
  arrange(external_gene_name)

# Checking for duplicate gene name in single-cell matrix
test <-  ct.sc.df %>%
    group_by(external_gene_name) %>%
    tally()
# No duplicate gene names in SC data

# Checking for duplicate gene names in biomaRt
mart.gene.dups <-  scGeneIDs.tbl %>%
  group_by(external_gene_name) %>%
  tally() %>%
  arrange(desc(n)) %>%
  filter(n > 1)

print(paste("There are ", dim(mart.gene.dups)[1], "duplicate gene names in biomaRt."))

ggplot(mart.gene.dups, aes(x=n)) + 
  geom_histogram(binwidth = 10) +
  labs(title="Gene Name Duplicates", x ="Number Duplicates", y = "Count")

# Only 1 duplicate ensembl id: ENSG00000273045 - C2orf15 in biomaRt
test <-  scGeneIDs.tbl %>%
    group_by(ensembl_gene_id) %>%
    tally()

# Join
ct.sc.gex <- as_tibble(left_join(x = ct.sc.df, y = scGeneIDs.tbl))
ct.sc.gex <- dplyr::select(ct.sc.gex, ensembl_gene_id, everything())

# Of the 19723 single-cell genes, including duplicates from mart, 3275 were missing (16.60 %) using biomaRt annotation
summary(is.na(ct.sc.gex$ensembl_gene_id))

# Sort SC matrix by ensembl id
ct.sc.gex <- 
  ct.sc.gex %>%
  arrange(ensembl_gene_id)

############
# Rename columns in bulk matrix to retain metadata and sort by ensembl_id
ct.bulk.tbl <- tibble(ensembl_gene_id = rownames(bulk.normalized),
                       KC40.ct.103905 = ct.bulk[,1],
                       KC48.ct.105816 = ct.bulk[,2])
ct.bulk.tbl <- ct.bulk.tbl %>% 
  arrange(ensembl_gene_id)

# Perform an inner join between the ensembl_id list from the single-cell data and the bulk data
dim(ct.sc.gex)
dim(ct.bulk.tbl)
gex.combined <- as_tibble(inner_join(ct.sc.gex, ct.bulk.tbl))
dim(gex.combined)

# No missing Gene IDs
summary(is.na(gex.combined$ensembl_gene_id))

# 39 gene name duplicates
test <- gex.combined %>%
  group_by(external_gene_name) %>%
  tally(sort = T)

test <- gex.combined %>%
  group_by(external_gene_name) %>%
  filter(n()>1)

# 22 ensembl_id duplicates
test <- gex.combined %>%
  group_by(ensembl_gene_id) %>%
  tally(sort = T)

test <- gex.combined %>%
  group_by(ensembl_gene_id) %>%
  filter(n()>1)

# Remove duplicate ensembl_ids, but not multiple IDs mapping to the same gene
gex.combined.filtered <- gex.combined %>%
  distinct(ensembl_gene_id, .keep_all = T)

# Successfully removed 22 duplicate IDs 14640 -> 14618
dim(gex.combined.filtered)

# Calculate single-cell mean
gex.average <- mutate(gex.combined.filtered, SC_mean = rowMeans(dplyr::select(gex.combined.filtered, matches("KC40_|KC42_"))))

test <- dplyr::select(gex.combined.filtered, matches("KC40_|KC42_"))

test <- dplyr::select(gex.combined.filtered, matches("103905|105816"))

# Calculate sorted mean
gex.average <- mutate(gex.average, Bulk_mean = rowMeans(dplyr::select(gex.average, matches("103905|105816"))))

# High expression outliers are all MT reads
High_bulk_expression <- filter(gex.average, Bulk_mean > 10000)
High_bulk_expression


smoothScatter(x = gex.average$SC_mean, y = gex.average$Bulk_mean)

ct.cor <- cor(gex.average$SC_mean, gex.average$Bulk_mean)
ct.cor

ggplot(gex.average) + aes(x=SC_mean, y=Bulk_mean, label = external_gene_name) +
  stat_density2d(geom="tile", aes(fill=..density..^0.25, alpha=1), contour=FALSE) + 
  geom_point(size=0.5) +
  stat_density2d(geom="tile", aes(fill=..density..^0.25, alpha=ifelse(..density..^0.25<0.4,0,1)), contour=FALSE) + 
  scale_fill_gradientn(colours = colorRampPalette(c("white", blues9))(256)) +
  geom_text(data=subset(gex.average, external_gene_name == "KRT7"))
```